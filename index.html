<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gesti√≥n de Compras - Casa Rural</title>
    <link rel="icon" type="image/x-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõí</text></svg>">
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="welcome-message">
            <h1>Gesti√≥n de la compra - Casa Rural</h1>
            <button id="helpButton" class="help-button" title="Ayuda">
                <span class="help-icon">‚ìò</span>
            </button>
        </div>

        <div class="table-container">
            <div class="filters-container">
                <div class="filter-group">
                    <label for="productoSearch">Buscar producto:</label>
                    <div class="search-input-container">
                        <input type="text" id="productoSearch" placeholder="Escribe para buscar...">
                        <button type="button" id="clearSearch" title="Limpiar b√∫squeda">‚úï</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="grupoFilter">Filtrar por Grupo:</label>
                    <select id="grupoFilter">
                        <option value="">Todos los grupos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="categoriaFilter">Filtrar por Categor√≠a:</label>
                    <select id="categoriaFilter">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Estado de compra:</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="estadoFilter" value="todos" checked>
                            <span>Todos</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="estadoFilter" value="comprado">
                            <span>Comprado</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="estadoFilter" value="no-comprado">
                            <span>No comprado</span>
                        </label>
                    </div>
                </div>
            </div>

            <div id="loading" class="loading">Cargando...</div>
            <div id="error" class="error" style="display: none;">
                <div class="error-message"></div>
                <button id="retryButton" class="retry-button">üîÑ Reintentar</button>
            </div>
            <div id="itemsContainer" class="items-container" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal de ayuda -->
    <div id="helpModal" class="help-modal" style="display: none;">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <h3>¬øC√≥mo usar la aplicaci√≥n?</h3>
                <button id="closeHelp" class="close-help">&times;</button>
            </div>
            <div class="help-modal-body">
                <div class="help-section">
                    <h4>üîç Filtros y b√∫squeda</h4>
                    <ul>
                        <li><strong>Buscar producto:</strong> Escribe cualquier parte del nombre del producto para
                            encontrarlo r√°pidamente. Usa el bot√≥n ‚úï para limpiar la b√∫squeda
                        </li>
                        <li><strong>Filtrar por Grupo:</strong> Selecciona un grupo espec√≠fico (ej: Celi y Ricardo, Alba
                            y Javi) para ver solo los productos de ese grupo
                        </li>
                        <li><strong>Filtrar por Categor√≠a:</strong> Filtra por tipo de producto (ej: Verduras, L√°cteos,
                            Carnes)
                        </li>
                        <li><strong>Estado de compra:</strong> Usa los botones de radio para filtrar por:
                            <ul>
                                <li><em>Todos</em> - Muestra todos los productos (por defecto)</li>
                                <li><em>Comprado</em> - Solo productos ya marcados como comprados</li>
                                <li><em>No comprado</em> - Solo productos pendientes por comprar</li>
                            </ul>
                        </li>
                        <li>Los n√∫meros entre par√©ntesis muestran <strong>(comprados de total)</strong> para hacer
                            seguimiento del progreso. Se actualizan din√°micamente seg√∫n los filtros aplicados
                        </li>
                        <li><strong>Combinar filtros:</strong> Puedes usar m√∫ltiples filtros al mismo tiempo para b√∫squedas muy espec√≠ficas</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>‚úÖ Marcar como comprado</h4>
                    <ul>
                        <li>Haz clic en el checkbox a la izquierda de cada producto para marcarlo como comprado
                        </li>
                        <li><strong>Los productos comprados se mueven autom√°ticamente al final de la lista</strong> con
                            una animaci√≥n suave y aparecen tachados
                        </li>
                        <li>Si desmarcas un producto comprado, volver√° al principio de la lista autom√°ticamente
                        </li>
                        <li>Tu progreso se guarda autom√°ticamente en el navegador local
                        </li>
                        <li>Los contadores de los filtros se actualizan inmediatamente al marcar/desmarcar productos</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üé® Colores y organizaci√≥n</h4>
                    <ul>
                        <li>Cada <span class="help-categoria">categor√≠a</span> tiene un color distintivo para
                            identificarla f√°cilmente (hasta 10 colores diferentes)
                        </li>
                        <li>Cada <span class="help-grupo">grupo</span> tambi√©n tiene su propio color √∫nico
                            (hasta 10 colores diferentes)
                        </li>
                        <li><strong>Ordenaci√≥n autom√°tica:</strong> Los productos pendientes aparecen siempre arriba, los comprados abajo (tachados)
                        </li>
                        <li>Las <strong>notas adicionales</strong> aparecen en una caja amarilla distintiva cuando est√°n disponibles</li>
                        <li>Cada producto muestra: <em>nombre, cantidad/unidad, categor√≠a, grupo y notas (si las hay)</em></li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üíæ Guardado autom√°tico</h4>
                    <ul>
                        <li><strong>Filtros:</strong> Todos los filtros seleccionados se guardan autom√°ticamente y se restauran al recargar la p√°gina
                        </li>
                        <li><strong>Estado de compras:</strong> Los productos marcados como comprados se mantienen al recargar la p√°gina
                        </li>
                        <li><strong>B√∫squeda:</strong> El texto de b√∫squeda tambi√©n se guarda y restaura
                        </li>
                        <li>Todo se almacena localmente en tu navegador (no se comparte con otros dispositivos)</li>
                        <li>Los datos se mantienen hasta que limpies la cach√© del navegador</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üîÑ Actualizaci√≥n autom√°tica</h4>
                    <ul>
                        <li><strong>Detecci√≥n de cambios:</strong> La aplicaci√≥n verifica autom√°ticamente cada 30 segundos si hay cambios en la lista de compras
                        </li>
                        <li>Si se detectan cambios (productos a√±adidos, modificados o eliminados), aparece un popup para notificarte
                        </li>
                        <li>Puedes elegir <em>Refrescar</em> para cargar los nuevos datos o <em>Ignorar</em> para continuar con la versi√≥n actual
                        </li>
                        <li>Los cambios se detectan incluso si otra persona modifica el documento Excel simult√°neamente</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üì± Consejos de uso</h4>
                    <ul>
                        <li><strong>Para ir de compras:</strong> Usa el filtro "No comprado" para ver solo lo que falta por comprar
                        </li>
                        <li><strong>Para revisar el progreso:</strong> Mant√©n "Todos" para ver pendientes arriba y comprados abajo
                        </li>
                        <li><strong>Para buscar algo espec√≠fico:</strong> Combina b√∫squeda por texto con filtros de grupo/categor√≠a
                        </li>
                        <li><strong>En dispositivos m√≥viles:</strong> La interfaz se adapta autom√°ticamente para una mejor experiencia t√°ctil
                        </li>
                        <li><strong>Si hay problemas:</strong> Usa el bot√≥n "üîÑ Reintentar" si aparece alg√∫n error de carga</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // URL del CSV de Google Sheets
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzU3A2YW5jGO4jF0lGpfEnJGCuUEOs1dKCl7zPVZma60j1sityN2DNhXW9RwJpEecyq-wUXow_5mtO/pub?output=csv";

        // Variables globales para almacenar datos
        let originalData = [];
        let currentData = [];
        let grupoColumnIndex = -1;
        let categoriaColumnIndex = -1;
        let productoColumnIndex = -1;
        let purchasedItems = new Set();
        let currentSort = { column: -1, direction: 'asc' };
        let checkInterval = null;
        let lastDataHash = null;

        // Paletas de colores para categor√≠as y grupos
        const colorPalettes = {
            categoria: [
                { bg: '#e3f2fd', text: '#1565c0', border: '#2196f3' }, // Azul
                { bg: '#f3e5f5', text: '#7b1fa2', border: '#9c27b0' }, // P√∫rpura
                { bg: '#e8f5e8', text: '#2e7d32', border: '#4caf50' }, // Verde
                { bg: '#fff3e0', text: '#ef6c00', border: '#ff9800' }, // Naranja
                { bg: '#fce4ec', text: '#c2185b', border: '#e91e63' }, // Rosa
                { bg: '#e0f2f1', text: '#00695c', border: '#009688' }, // Teal
                { bg: '#f9fbe7', text: '#827717', border: '#cddc39' }, // Lima
                { bg: '#e1f5fe', text: '#0277bd', border: '#03a9f4' }, // Azul claro
                { bg: '#fff8e1', text: '#f57f17', border: '#ffeb3b' }, // Amarillo
                { bg: '#efebe9', text: '#5d4037', border: '#795548' }  // Marr√≥n
            ],
            grupo: [
                { bg: '#ffebee', text: '#c62828', border: '#f44336' }, // Rojo
                { bg: '#e8eaf6', text: '#303f9f', border: '#3f51b5' }, // √çndigo
                { bg: '#e4f4fd', text: '#1976d2', border: '#2196f3' }, // Azul material
                { bg: '#e0f7fa', text: '#00838f', border: '#00bcd4' }, // Cian
                { bg: '#f1f8e9', text: '#558b2f', border: '#8bc34a' }, // Verde claro
                { bg: '#fff9c4', text: '#f9a825', border: '#ffc107' }, // √Åmbar
                { bg: '#fbe9e7', text: '#d84315', border: '#ff5722' }, // Naranja profundo
                { bg: '#f3e5f5', text: '#8e24aa', border: '#9c27b0' }, // P√∫rpura material
                { bg: '#e8f5e8', text: '#388e3c', border: '#4caf50' }, // Verde material
                { bg: '#ede7f6', text: '#512da8', border: '#673ab7' }  // Violeta profundo
            ]
        };

        // Mapas para almacenar colores asignados
        let categoriaColors = new Map();
        let grupoColors = new Map();

        // Funci√≥n para asignar color a una categor√≠a
        function getCategoriaColor(categoria) {
            if (!categoria) return null;

            if (!categoriaColors.has(categoria)) {
                const colorIndex = categoriaColors.size % colorPalettes.categoria.length;
                categoriaColors.set(categoria, colorPalettes.categoria[colorIndex]);
            }

            return categoriaColors.get(categoria);
        }

        // Funci√≥n para asignar color a un grupo
        function getGrupoColor(grupo) {
            if (!grupo) return null;

            if (!grupoColors.has(grupo)) {
                const colorIndex = grupoColors.size % colorPalettes.grupo.length;
                grupoColors.set(grupo, colorPalettes.grupo[colorIndex]);
            }

            return grupoColors.get(grupo);
        }

        // Cargar estado de localStorage
        function loadPurchasedState() {
            const saved = localStorage.getItem('purchasedItems');
            if (saved) {
                purchasedItems = new Set(JSON.parse(saved));
            }
        }

        // Guardar estado en localStorage
        function savePurchasedState() {
            localStorage.setItem('purchasedItems', JSON.stringify([...purchasedItems]));
        }

        // Cargar filtros guardados de localStorage
        function loadFiltersState() {
            const savedGrupo = localStorage.getItem('grupoFilter');
            const savedCategoria = localStorage.getItem('categoriaFilter');
            const savedProductoSearch = localStorage.getItem('productoSearch');
            const savedEstadoFilter = localStorage.getItem('estadoFilter');

            if (savedGrupo) {
                const grupoSelect = document.getElementById('grupoFilter');
                if (grupoSelect) {
                    grupoSelect.value = savedGrupo;
                }
            }

            if (savedCategoria) {
                const categoriaSelect = document.getElementById('categoriaFilter');
                if (categoriaSelect) {
                    categoriaSelect.value = savedCategoria;
                }
            }

            if (savedProductoSearch) {
                const productoSearchInput = document.getElementById('productoSearch');
                if (productoSearchInput) {
                    productoSearchInput.value = savedProductoSearch;
                }
            }

            if (savedEstadoFilter) {
                const estadoRadio = document.querySelector(`input[name="estadoFilter"][value="${savedEstadoFilter}"]`);
                if (estadoRadio) {
                    estadoRadio.checked = true;
                }
            }
        }

        // Guardar filtros en localStorage
        function saveFiltersState() {
            const grupoFilter = document.getElementById('grupoFilter').value;
            const categoriaFilter = document.getElementById('categoriaFilter').value;
            const productoSearch = document.getElementById('productoSearch').value;
            const estadoFilter = document.querySelector('input[name="estadoFilter"]:checked').value;

            localStorage.setItem('grupoFilter', grupoFilter);
            localStorage.setItem('categoriaFilter', categoriaFilter);
            localStorage.setItem('productoSearch', productoSearch);
            localStorage.setItem('estadoFilter', estadoFilter);
        }

        // Generar ID √∫nico para cada fila basado en su contenido
        function generateRowId(row) {
            return btoa(row.join('|')).replace(/[^a-zA-Z0-9]/g, '');
        }

        // Funci√≥n para parsear CSV
        function parseCSV(text) {
            const lines = text.split('\n');
            const result = [];

            for (let line of lines) {
                if (line.trim()) {
                    // Simple CSV parsing - handles basic cases
                    const row = line.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                    result.push(row);
                }
            }

            return result;
        }

        // Funci√≥n para ordenar datos
        function sortData(columnIndex, direction = 'asc') {
            if (!currentData.length || columnIndex < 0) return;

            const headers = currentData[0];
            const dataRows = currentData.slice(1);

            dataRows.sort((a, b) => {
                const valueA = (a[columnIndex] || '').toString().toLowerCase();
                const valueB = (b[columnIndex] || '').toString().toLowerCase();

                if (direction === 'asc') {
                    return valueA.localeCompare(valueB, 'es', { numeric: true });
                } else {
                    return valueB.localeCompare(valueA, 'es', { numeric: true });
                }
            });

            const sortedData = [headers, ...dataRows];
            createTable(sortedData);
        }

        // Funci√≥n para manejar click en encabezado
        function handleHeaderClick(columnIndex, columnName) {
            const sortableColumns = ['Producto', 'Grupo', 'Categor√≠a'];
            if (!sortableColumns.includes(columnName)) return;

            let direction = 'asc';
            if (currentSort.column === columnIndex && currentSort.direction === 'asc') {
                direction = 'desc';
            }

            currentSort = { column: columnIndex, direction };
            sortData(columnIndex, direction);
            updateSortIndicators();
        }

        // Funci√≥n para actualizar indicadores de ordenaci√≥n
        function updateSortIndicators() {
            const headers = document.querySelectorAll('#tableHeader th');
            headers.forEach((th, index) => {
                const sortIcon = th.querySelector('.sort-icon');
                if (sortIcon) {
                    if (currentSort.column === index - 1) { // -1 porque el checkbox ocupa el primer √≠ndice
                        sortIcon.textContent = currentSort.direction === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
                        sortIcon.style.opacity = '1';
                    } else {
                        sortIcon.textContent = ' ‚ñ≤‚ñº';
                        sortIcon.style.opacity = '0.3';
                    }
                }
            });
        }

        // Funci√≥n para actualizar filtros din√°micamente seg√∫n la selecci√≥n actual
        function updateFiltersBasedOnSelection() {
            if (!originalData.length) return;

            const grupoFilter = document.getElementById('grupoFilter').value;
            const categoriaFilter = document.getElementById('categoriaFilter').value;
            const estadoFilter = document.querySelector('input[name="estadoFilter"]:checked').value;
            const headers = originalData[0];

            // Obtener datos filtrados para calcular opciones disponibles
            let availableData = originalData.slice(1); // Sin headers

            // Si hay filtro de grupo, filtrar primero por grupo
            if (grupoFilter && grupoColumnIndex !== -1) {
                availableData = availableData.filter(row => row[grupoColumnIndex] === grupoFilter);
            }

            // Si hay filtro de categor√≠a, filtrar por categor√≠a
            if (categoriaFilter && categoriaColumnIndex !== -1) {
                availableData = availableData.filter(row => row[categoriaColumnIndex] === categoriaFilter);
            }

            // Filtrar por estado de compra
            if (estadoFilter === 'comprado') {
                availableData = availableData.filter(row => {
                    const rowId = generateRowId(row);
                    return purchasedItems.has(rowId);
                });
            } else if (estadoFilter === 'no-comprado') {
                availableData = availableData.filter(row => {
                    const rowId = generateRowId(row);
                    return !purchasedItems.has(rowId);
                });
            }

            // Calcular estad√≠sticas para grupos disponibles
            const grupos = new Map();
            const categorias = new Map();

            availableData.forEach(row => {
                const rowId = generateRowId(row);
                const isComprado = purchasedItems.has(rowId);

                if (grupoColumnIndex !== -1 && row[grupoColumnIndex]) {
                    const grupo = row[grupoColumnIndex];
                    if (!grupos.has(grupo)) {
                        grupos.set(grupo, { total: 0, comprados: 0 });
                    }
                    const stats = grupos.get(grupo);
                    stats.total += 1;
                    if (isComprado) stats.comprados += 1;
                }

                if (categoriaColumnIndex !== -1 && row[categoriaColumnIndex]) {
                    const categoria = row[categoriaColumnIndex];
                    if (!categorias.has(categoria)) {
                        categorias.set(categoria, { total: 0, comprados: 0 });
                    }
                    const stats = categorias.get(categoria);
                    stats.total += 1;
                    if (isComprado) stats.comprados += 1;
                }
            });

            // Actualizar selector de grupos
            const grupoSelect = document.getElementById('grupoFilter');
            const currentGrupoValue = grupoSelect.value;
            grupoSelect.innerHTML = '<option value="">Todos los grupos</option>';

            // Si no hay filtro de categor√≠a, mostrar todos los grupos originales
            if (!categoriaFilter) {
                // Recalcular con todos los datos originales para grupos
                const allGrupos = new Map();
                for (let i = 1; i < originalData.length; i++) {
                    const row = originalData[i];
                    const rowId = generateRowId(row);
                    const isComprado = purchasedItems.has(rowId);

                    if (grupoColumnIndex !== -1 && row[grupoColumnIndex]) {
                        const grupo = row[grupoColumnIndex];
                        if (!allGrupos.has(grupo)) {
                            allGrupos.set(grupo, { total: 0, comprados: 0 });
                        }
                        const stats = allGrupos.get(grupo);
                        stats.total += 1;
                        if (isComprado) stats.comprados += 1;
                    }
                }

                allGrupos.forEach((stats, grupo) => {
                    const option = document.createElement('option');
                    option.value = grupo;
                    option.textContent = `${grupo} (${stats.comprados} de ${stats.total})`;
                    grupoSelect.appendChild(option);
                });
            } else {
                // Mostrar solo grupos que tienen la categor√≠a seleccionada
                grupos.forEach((stats, grupo) => {
                    const option = document.createElement('option');
                    option.value = grupo;
                    option.textContent = `${grupo} (${stats.comprados} de ${stats.total})`;
                    grupoSelect.appendChild(option);
                });
            }

            grupoSelect.value = currentGrupoValue;

            // Actualizar selector de categor√≠as
            const categoriaSelect = document.getElementById('categoriaFilter');
            const currentCategoriaValue = categoriaSelect.value;
            categoriaSelect.innerHTML = '<option value="">Todas las categor√≠as</option>';

            // Si no hay filtro de grupo, mostrar todas las categor√≠as originales
            if (!grupoFilter) {
                // Recalcular con todos los datos originales para categor√≠as
                const allCategorias = new Map();
                for (let i = 1; i < originalData.length; i++) {
                    const row = originalData[i];
                    const rowId = generateRowId(row);
                    const isComprado = purchasedItems.has(rowId);

                    if (categoriaColumnIndex !== -1 && row[categoriaColumnIndex]) {
                        const categoria = row[categoriaColumnIndex];
                        if (!allCategorias.has(categoria)) {
                            allCategorias.set(categoria, { total: 0, comprados: 0 });
                        }
                        const stats = allCategorias.get(categoria);
                        stats.total += 1;
                        if (isComprado) stats.comprados += 1;
                    }
                }

                allCategorias.forEach((stats, categoria) => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = `${categoria} (${stats.comprados} de ${stats.total})`;
                    categoriaSelect.appendChild(option);
                });
            } else {
                // Mostrar solo categor√≠as que tienen el grupo seleccionado
                categorias.forEach((stats, categoria) => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = `${categoria} (${stats.comprados} de ${stats.total})`;
                    categoriaSelect.appendChild(option);
                });
            }

            categoriaSelect.value = currentCategoriaValue;
        }

        // Funci√≥n para poblar los filtros
        function populateFilters(data) {
            if (data.length === 0) return;

            const headers = data[0];

            // Encontrar √≠ndices de las columnas
            grupoColumnIndex = headers.indexOf('Grupo');
            categoriaColumnIndex = headers.indexOf('Categor√≠a');
            productoColumnIndex = headers.indexOf('Producto');

            if (grupoColumnIndex === -1 && categoriaColumnIndex === -1) return;

            // Actualizar filtros din√°micamente
            updateFiltersBasedOnSelection();

            // Cargar filtros guardados
            loadFiltersState();

            // Agregar event listeners que tambi√©n guarden el estado y actualicen filtros
            const grupoSelect = document.getElementById('grupoFilter');
            const categoriaSelect = document.getElementById('categoriaFilter');
            const productoSearchInput = document.getElementById('productoSearch');
            const clearSearchButton = document.getElementById('clearSearch');

            grupoSelect.addEventListener('change', () => {
                saveFiltersState();
                updateFiltersBasedOnSelection();
                filterData();
            });

            categoriaSelect.addEventListener('change', () => {
                saveFiltersState();
                updateFiltersBasedOnSelection();
                filterData();
            });

            // Event listener para b√∫squeda de producto
            productoSearchInput.addEventListener('input', () => {
                saveFiltersState();
                filterData();
            });

            // Event listener para bot√≥n de limpiar b√∫squeda
            clearSearchButton.addEventListener('click', () => {
                productoSearchInput.value = '';
                saveFiltersState();
                filterData();
                productoSearchInput.focus();
            });

            // Event listeners para los radio buttons de estado de compra
            const estadoRadios = document.querySelectorAll('input[name="estadoFilter"]');
            estadoRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    saveFiltersState();
                    updateFiltersBasedOnSelection();
                    filterData();
                });
            });
        }

        // Funci√≥n para filtrar datos
        function filterData() {
            const grupoFilter = document.getElementById('grupoFilter').value;
            const categoriaFilter = document.getElementById('categoriaFilter').value;
            const productoSearch = document.getElementById('productoSearch').value.toLowerCase().trim();
            const estadoFilter = document.querySelector('input[name="estadoFilter"]:checked').value;

            if (!originalData.length) return;

            let filteredData = [originalData[0]]; // Mantener headers

            for (let i = 1; i < originalData.length; i++) {
                const row = originalData[i];
                let showRow = true;

                // Filtrar por grupo
                if (grupoFilter && grupoColumnIndex !== -1) {
                    if (row[grupoColumnIndex] !== grupoFilter) {
                        showRow = false;
                    }
                }

                // Filtrar por categor√≠a
                if (categoriaFilter && categoriaColumnIndex !== -1) {
                    if (row[categoriaColumnIndex] !== categoriaFilter) {
                        showRow = false;
                    }
                }

                // Filtrar por b√∫squeda de producto
                if (productoSearch && productoColumnIndex !== -1) {
                    const producto = (row[productoColumnIndex] || '').toLowerCase();
                    if (!producto.includes(productoSearch)) {
                        showRow = false;
                    }
                }

                // Filtrar por estado de compra
                if (estadoFilter === 'comprado') {
                    const rowId = generateRowId(row);
                    if (!purchasedItems.has(rowId)) {
                        showRow = false;
                    }
                } else if (estadoFilter === 'no-comprado') {
                    const rowId = generateRowId(row);
                    if (purchasedItems.has(rowId)) {
                        showRow = false;
                    }
                }

                if (showRow) {
                    filteredData.push(row);
                }
            }

            currentData = filteredData;

            // Aplicar ordenaci√≥n actual si existe
            if (currentSort.column >= 0) {
                sortData(currentSort.column, currentSort.direction);
            } else {
                createTable(filteredData);
            }

            // Resetear scroll al inicio despu√©s de filtrar
            const itemsContainer = document.getElementById('itemsContainer');
            if (itemsContainer) {
                itemsContainer.scrollTop = 0;
            }
        }

        // Funci√≥n para crear la vista de tarjetas
        function createTable(data) {
            const itemsContainer = document.getElementById('itemsContainer');

            // Limpiar contenido anterior
            itemsContainer.innerHTML = '';

            if (data.length === 0) {
                showError('No hay datos disponibles');
                return;
            }

            // Verificar si hay datos despu√©s de los headers
            if (data.length === 1) {
                // Solo hay headers, no hay datos que mostrar
                const noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'no-results';
                noResultsDiv.innerHTML = `
                    <div class="no-results-icon">üîç</div>
                    <div class="no-results-message">No se encontraron resultados</div>
                    <div class="no-results-suggestion">Prueba a cambiar los filtros para ver m√°s elementos</div>
                `;
                itemsContainer.appendChild(noResultsDiv);

                hideLoading();
                itemsContainer.style.display = 'block';
                return;
            }

            // Guardar datos actuales
            currentData = data;
            const headers = data[0];

            // Encontrar √≠ndices de columnas
            const indices = {
                producto: headers.indexOf('Producto'),
                cantidad: headers.indexOf('Cantidad'),
                unidad: headers.indexOf('Unidad'),
                categoria: headers.indexOf('Categor√≠a'),
                grupo: headers.indexOf('Grupo'),
                notas: headers.indexOf('Notas')
            };

            // Separar elementos comprados y no comprados
            const dataRows = data.slice(1);
            const notPurchased = [];
            const purchased = [];

            dataRows.forEach(row => {
                const rowId = generateRowId(row);
                if (purchasedItems.has(rowId)) {
                    purchased.push(row);
                } else {
                    notPurchased.push(row);
                }
            });

            // Crear tarjetas ordenadas: primero no comprados, luego comprados
            const orderedRows = [...notPurchased, ...purchased];

            // Crear tarjetas de datos
            orderedRows.forEach((row, index) => {
                const rowId = generateRowId(row);

                // Crear contenedor de tarjeta
                const card = document.createElement('div');
                card.className = 'item-card';
                card.setAttribute('data-row-id', rowId);

                // Contenedor izquierdo para checkbox
                const leftSection = document.createElement('div');
                leftSection.className = 'card-left';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'purchase-checkbox';
                checkbox.checked = purchasedItems.has(rowId);
                checkbox.addEventListener('change', () => handlePurchaseToggle(checkbox, rowId));
                leftSection.appendChild(checkbox);

                // Contenedor derecho para informaci√≥n
                const rightSection = document.createElement('div');
                rightSection.className = 'card-right';

                // Primera l√≠nea: Producto, Cantidad, Unidad
                const line1 = document.createElement('div');
                line1.className = 'card-line line-1';

                const producto = document.createElement('span');
                producto.className = 'producto';
                producto.textContent = row[indices.producto] || '';

                const cantidadUnidad = document.createElement('span');
                cantidadUnidad.className = 'cantidad-unidad';
                const cantidad = row[indices.cantidad] || '';
                const unidad = row[indices.unidad] || '';
                cantidadUnidad.textContent = cantidad + (unidad ? ` ${unidad}` : '');

                line1.appendChild(producto);
                line1.appendChild(cantidadUnidad);

                // Segunda l√≠nea: Categor√≠a y Grupo
                const line2 = document.createElement('div');
                line2.className = 'card-line line-2';

                const categoria = document.createElement('span');
                categoria.className = 'categoria';
                categoria.textContent = row[indices.categoria] || '';

                const grupo = document.createElement('span');
                grupo.className = 'grupo';
                grupo.textContent = row[indices.grupo] || '';

                line2.appendChild(categoria);
                line2.appendChild(grupo);

                // Tercera l√≠nea: Notas (solo si hay contenido)
                const notasContent = row[indices.notas] || '';
                let line3 = null;
                if (notasContent.trim()) {
                    line3 = document.createElement('div');
                    line3.className = 'card-line line-3';

                    const notas = document.createElement('span');
                    notas.className = 'notas';
                    notas.textContent = notasContent;

                    line3.appendChild(notas);
                }

                // Agregar l√≠neas al contenedor derecho
                rightSection.appendChild(line1);
                rightSection.appendChild(line2);
                if (line3) {
                    rightSection.appendChild(line3);
                }

                // Agregar secciones a la tarjeta
                card.appendChild(leftSection);
                card.appendChild(rightSection);

                // Aplicar clase de comprado si est√° marcado
                if (purchasedItems.has(rowId)) {
                    card.classList.add('purchased');
                }

                // Asignar colores a categor√≠as y grupos
                const categoriaColor = getCategoriaColor(row[indices.categoria]);
                const grupoColor = getGrupoColor(row[indices.grupo]);

                if (categoriaColor) {
                    const { bg, text, border } = categoriaColor;
                    categoria.style.backgroundColor = bg;
                    categoria.style.color = text;
                    categoria.style.borderColor = border;
                }

                if (grupoColor) {
                    const { bg, text, border } = grupoColor;
                    grupo.style.backgroundColor = bg;
                    grupo.style.color = text;
                    grupo.style.borderColor = border;
                }

                itemsContainer.appendChild(card);
            });

            // Mostrar contenedor de tarjetas
            hideLoading();
            itemsContainer.style.display = 'block';
        }

        // Funci√≥n para mover elemento con animaci√≥n
        function moveElementToPosition(element, isMovingToEnd) {
            // A√±adir clase de animaci√≥n
            element.classList.add('moving');

            if (isMovingToEnd) {
                element.style.transform = 'translateX(100%)';
                element.style.opacity = '0.3';
            } else {
                element.style.transform = 'translateX(-100%)';
                element.style.opacity = '0.3';
            }

            // Despu√©s de la animaci√≥n, reordenar la lista
            setTimeout(() => {
                // Recrear la tabla con el nuevo orden
                createTable(currentData);
            }, 300);
        }

        // Manejar cambio de estado de compra
        function handlePurchaseToggle(checkbox, rowId) {
            const card = checkbox.closest('.item-card');
            const wasChecked = !checkbox.checked; // Estado anterior

            if (checkbox.checked) {
                purchasedItems.add(rowId);
                card.classList.add('purchased');
                // Mover al final con animaci√≥n
                moveElementToPosition(card, true);
            } else {
                purchasedItems.delete(rowId);
                card.classList.remove('purchased');
                // Mover al principio con animaci√≥n
                moveElementToPosition(card, false);
            }

            savePurchasedState();

            // Actualizar los filtros para reflejar los nuevos conteos
            setTimeout(() => {
                populateFilters(originalData);
            }, 350);
        }

        // Funci√≥n para mostrar loading
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('itemsContainer').style.display = 'none';
        }

        // Funci√≥n para ocultar loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Funci√≥n para mostrar error
        function showError(message) {
            hideLoading();
            const errorDiv = document.getElementById('error');
            errorDiv.querySelector('.error-message').textContent = message;
            errorDiv.style.display = 'block';

            // A√±adir event listener al bot√≥n de reintentar si no existe ya
            const retryButton = document.getElementById('retryButton');
            if (retryButton && !retryButton.hasAttribute('data-listener-added')) {
                retryButton.addEventListener('click', () => {
                    errorDiv.style.display = 'none';
                    loadData();
                });
                retryButton.setAttribute('data-listener-added', 'true');
            }
        }

        // Funci√≥n para cargar datos
        async function loadData() {
            showLoading();

            try {
                // A√±adir timestamp para evitar cache
                const timestamp = new Date().getTime();
                const urlWithCache = `${CSV_URL}&_cache_bust=${timestamp}`;
                const response = await fetch(urlWithCache);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csvText = await response.text();
                const data = parseCSV(csvText);

                // Guardar datos originales
                originalData = data;
                currentData = data;

                // Establecer hash inicial para detectar cambios futuros
                lastDataHash = generateDataHash(data);

                // Resetear ordenaci√≥n
                currentSort = { column: -1, direction: 'asc' };

                // Cargar estado de compras
                loadPurchasedState();

                // Poblar filtros
                populateFilters(data);

                // Cargar filtros guardados y aplicarlos
                loadFiltersState();

                // Actualizar contadores despu√©s de cargar filtros guardados
                setTimeout(() => {
                    updateFiltersBasedOnSelection();
                    
                    // Aplicar filtros guardados si existen
                    const savedGrupo = localStorage.getItem('grupoFilter');
                    const savedCategoria = localStorage.getItem('categoriaFilter');
                    const savedProductoSearch = localStorage.getItem('productoSearch');

                    if (savedGrupo || savedCategoria || savedProductoSearch) {
                        filterData();
                    } else {
                        createTable(data);
                    }
                }, 100);

            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error al cargar los datos');
            }
        }

        // Funci√≥n para generar hash de los datos para detectar cambios
        function generateDataHash(data) {
            const jsonString = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < jsonString.length; i++) {
                const char = jsonString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convertir a 32-bit integer
            }
            return hash.toString();
        }

        // Funci√≥n para mostrar popup de cambios detectados
        function showChangesDetectedPopup() {
            // Crear overlay del popup
            const overlay = document.createElement('div');
            overlay.id = 'changesOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            // Crear contenido del popup
            const popup = document.createElement('div');
            popup.style.cssText = `
                background: linear-gradient(145deg, #ffffff, #f8f9fa);
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                padding: 30px;
                max-width: 400px;
                width: 100%;
                text-align: center;
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;

            popup.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 16px;">üîÑ</div>
                <h3 style="color: #2c3e50; margin: 0 0 16px; font-size: 1.4rem;">¬°Cambios detectados!</h3>
                <p style="color: #495057; margin: 0 0 24px; line-height: 1.5;">
                    Se han detectado cambios en la lista de compras. 
                    Haz clic en "Refrescar" para cargar los nuevos datos.
                </p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button id="dismissChanges" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.3s ease;
                    ">Ignorar</button>
                    <button id="refreshPage" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    ">Refrescar</button>
                </div>
            `;

            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            // Event listeners para los botones
            document.getElementById('dismissChanges').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });

            document.getElementById('refreshPage').addEventListener('click', () => {
                location.reload();
            });

            // Efecto hover para los botones
            const buttons = popup.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', () => {
                    button.style.transform = 'translateY(-2px)';
                });
                button.addEventListener('mouseleave', () => {
                    button.style.transform = 'translateY(0)';
                });
            });
        }

        // Funci√≥n para verificar cambios en los datos
        async function checkForDataChanges() {
            try {
                // A√±adir timestamp para evitar cache tambi√©n en las verificaciones
                const timestamp = new Date().getTime();
                const urlWithCache = `${CSV_URL}&_cache_bust=${timestamp}`;
                const response = await fetch(urlWithCache);

                if (!response.ok) {
                    console.log('Error al verificar cambios:', response.status);
                    return;
                }

                const csvText = await response.text();
                const newData = parseCSV(csvText);
                const newDataHash = generateDataHash(newData);

                // Si hay un hash previo y es diferente, mostrar popup
                if (lastDataHash && lastDataHash !== newDataHash) {
                    console.log('Cambios detectados en los datos');
                    showChangesDetectedPopup();
                    // Detener el temporizador para evitar m√∫ltiples popups
                    if (checkInterval) {
                        clearInterval(checkInterval);
                        checkInterval = null;
                    }
                }

                // Actualizar el hash para futuras comparaciones
                lastDataHash = newDataHash;

            } catch (error) {
                console.log('Error al verificar cambios:', error);
            }
        }

        // Funci√≥n para iniciar el temporizador de verificaci√≥n
        function startDataChangeTimer() {
            // Verificar cada 30 segundos
            checkInterval = setInterval(checkForDataChanges, 30000);
            console.log('Temporizador de verificaci√≥n de cambios iniciado (cada 30s)');
        }

        // Funci√≥n para detener el temporizador
        function stopDataChangeTimer() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
                console.log('Temporizador de verificaci√≥n detenido');
            }
        }

        // Cargar datos cuando la p√°gina est√© lista
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            startDataChangeTimer(); // Iniciar el temporizador al cargar

            // Manejar apertura y cierre del modal de ayuda
            const helpButton = document.getElementById('helpButton');
            const helpModal = document.getElementById('helpModal');
            const closeHelp = document.getElementById('closeHelp');

            helpButton.addEventListener('click', () => {
                helpModal.style.display = 'block';
            });

            closeHelp.addEventListener('click', () => {
                helpModal.style.display = 'none';
            });

            // Cerrar modal de ayuda si se hace clic fuera del contenido
            window.addEventListener('click', (event) => {
                if (event.target === helpModal) {
                    helpModal.style.display = 'none';
                }
            });
        });
    </script>
</body>

</html>
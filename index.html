<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gesti√≥n de Compras - Casa Rural</title>
    <link rel="icon" type="image/x-icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõí</text></svg>">
    <link rel="stylesheet" href="styles.css?v=2025-07-29-01">
</head>

<body>
    <div class="container">
        <div id="pullToRefreshIndicator" class="pull-to-refresh-indicator">
            <span class="pull-refresh-icon">‚Üì</span>
            <span class="pull-refresh-text">Desliza para actualizar</span>
        </div>

        <div class="welcome-message">
            <h1>Gesti√≥n de la compra - Casa Rural</h1>
            <button id="helpButton" class="help-button" title="Ayuda">
                <span class="help-icon">‚ìò</span>
            </button>
        </div>

        <div class="table-container">
            <div class="filters-container">
                <div class="filter-group">
                    <label for="productoSearch">Buscar producto:</label>
                    <div class="search-input-container">
                        <input type="text" id="productoSearch" placeholder="Escribe para buscar...">
                        <button type="button" id="clearSearch" title="Limpiar b√∫squeda">‚úï</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="grupoFilter">Filtrar por Grupo:</label>
                    <select id="grupoFilter">
                        <option value="">Todos los grupos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="categoriaFilter">Filtrar por Categor√≠a:</label>
                    <select id="categoriaFilter">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Estado de compra:</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="estadoFilter" value="todos" checked>
                            <span>Todos</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="estadoFilter" value="no-comprado">
                            <span>No comprado</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="estadoFilter" value="comprado">
                            <span>Comprado</span>
                        </label>
                    </div>
                </div>
            </div>

            <div id="loading" class="loading">Cargando...</div>
            <div id="error" class="error" style="display: none;">
                <div class="error-message"></div>
                <button id="retryButton" class="retry-button">üîÑ Reintentar</button>
            </div>
            <div id="itemsContainer" class="items-container" style="display: none;"></div>
        </div>
    </div>

    <div id="helpModal" class="help-modal" style="display: none;">
        <div class="help-modal-content">
            <div class="help-modal-header">
                <h3>¬øC√≥mo usar la aplicaci√≥n?</h3>
                <button id="closeHelp" class="close-help">&times;</button>
            </div>
            <div class="help-modal-body">
                <div class="help-section">
                    <h4>üîç Filtros y b√∫squeda</h4>
                    <ul>
                        <li><strong>Buscar producto:</strong> Escribe cualquier parte del nombre del producto para
                            encontrarlo r√°pidamente. Usa el bot√≥n ‚úï para limpiar la b√∫squeda
                        </li>
                        <li><strong>Filtrar por Grupo:</strong> Selecciona un grupo espec√≠fico (ej: Celi y Ricardo, Alba
                            y Javi) para ver solo los productos de ese grupo
                        </li>
                        <li><strong>Filtrar por Categor√≠a:</strong> Filtra por tipo de producto (ej: Verduras, L√°cteos,
                            Carnes)
                        </li>
                        <li><strong>Estado de compra:</strong> Usa los botones de radio para filtrar por:
                            <ul>
                                <li><em>Todos</em> - Muestra todos los productos (por defecto)</li>
                                <li><em>Comprado</em> - Solo productos ya marcados como comprados</li>
                                <li><em>No comprado</em> - Solo productos pendientes por comprar</li>
                            </ul>
                        </li>
                        <li>Los n√∫meros entre par√©ntesis muestran <strong>(comprados de total)</strong> para hacer
                            seguimiento del progreso. Se actualizan din√°micamente seg√∫n los filtros aplicados
                        </li>
                        <li><strong>Combinar filtros:</strong> Puedes usar m√∫ltiples filtros al mismo tiempo para
                            b√∫squedas muy espec√≠ficas</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>‚úÖ Marcar como comprado</h4>
                    <ul>
                        <li>Haz clic en el checkbox a la izquierda de cada producto para marcarlo como comprado
                        </li>
                        <li><strong>Los productos comprados se mueven autom√°ticamente al final de la lista</strong> con
                            una animaci√≥n suave y aparecen tachados
                        </li>
                        <li>Si desmarcas un producto comprado, volver√° al principio de la lista autom√°ticamente
                        </li>
                        <li>Tu progreso se guarda autom√°ticamente en el navegador local
                        </li>
                        <li>Los contadores de los filtros se actualizan inmediatamente al marcar/desmarcar productos
                        </li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üé® Colores y organizaci√≥n</h4>
                    <ul>
                        <li>Cada <span class="help-categoria">categor√≠a</span> tiene un color distintivo para
                            identificarla f√°cilmente (hasta 10 colores diferentes)
                        </li>
                        <li>Cada <span class="help-grupo">grupo</span> tambi√©n tiene su propio color √∫nico
                            (hasta 10 colores diferentes)
                        </li>
                        <li><strong>Ordenaci√≥n autom√°tica:</strong> Los productos pendientes aparecen siempre arriba,
                            los comprados abajo (tachados)
                        </li>
                        <li>Las <strong>notas adicionales</strong> aparecen en una caja amarilla distintiva cuando est√°n
                            disponibles</li>
                        <li>Cada producto muestra: <em>nombre, cantidad/unidad, categor√≠a, grupo y notas (si las
                                hay)</em></li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üíæ Guardado autom√°tico</h4>
                    <ul>
                        <li><strong>Filtros:</strong> Todos los filtros seleccionados se guardan autom√°ticamente y se
                            restauran al recargar la p√°gina
                        </li>
                        <li><strong>Estado de compras:</strong> Los productos marcados como comprados se mantienen al
                            recargar la p√°gina
                        </li>
                        <li><strong>B√∫squeda:</strong> El texto de b√∫squeda tambi√©n se guarda y restaura
                        </li>
                        <li>Todo se almacena localmente en tu navegador (no se comparte con otros dispositivos)</li>
                        <li>Los datos se mantienen hasta que limpies la cach√© del navegador</li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üîÑ Actualizaci√≥n autom√°tica</h4>
                    <ul>
                        <li><strong>Detecci√≥n de cambios:</strong> La aplicaci√≥n verifica autom√°ticamente cada 30
                            segundos si hay cambios en la lista de compras
                        </li>
                        <li>Si se detectan cambios (productos a√±adidos, modificados o eliminados), aparece un popup para
                            notificarte
                        </li>
                        <li>Puedes elegir <em>Refrescar</em> para cargar los nuevos datos o <em>Ignorar</em> para
                            continuar con la versi√≥n actual
                        </li>
                        <li>Los cambios se detectan incluso si otra persona modifica el documento Excel simult√°neamente
                        </li>
                    </ul>
                </div>

                <div class="help-section">
                    <h4>üì± Consejos de uso</h4>
                    <ul>
                        <li><strong>Para ir de compras:</strong> Usa el filtro "No comprado" para ver solo lo que falta
                            por comprar
                        </li>
                        <li><strong>Para revisar el progreso:</strong> Mant√©n "Todos" para ver pendientes arriba y
                            comprados abajo
                        </li>
                        <li><strong>Para buscar algo espec√≠fico:</strong> Combina b√∫squeda por texto con filtros de
                            grupo/categor√≠a
                        </li>
                        <li><strong>En dispositivos m√≥viles:</strong> La interfaz se adapta autom√°ticamente para una
                            mejor experiencia t√°ctil
                        </li>
                        <li><strong>Si hay problemas:</strong> Usa el bot√≥n "üîÑ Reintentar" si aparece alg√∫n error de
                            carga</li>
                    </ul>
                </div>

                <div class="help-section danger-section">
                    <h4>‚ö†Ô∏è Zona de peligro</h4>
                    <p style="margin-bottom: 15px; color: #dc3545; font-weight: 500;">
                        ¬°Cuidado! Esta acci√≥n eliminar√° permanentemente todos los datos guardados:
                    </p>
                    <ul style="margin-bottom: 20px;">
                        <li>Todos los productos marcados como comprados</li>
                        <li>Filtros guardados (grupo, categor√≠a, b√∫squeda)</li>
                        <li>Estado de b√∫squeda actual</li>
                    </ul>
                    <button id="resetAppButton" class="reset-button">
                        üóëÔ∏è Resetear aplicaci√≥n completa
                    </button>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #6c757d; font-style: italic;">
                        Se pedir√° confirmaci√≥n antes de ejecutar
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzU3A2YW5jGO4jF0lGpfEnJGCuUEOs1dKCl7zPVZma60j1sityN2DNhXW9RwJpEecyq-wUXow_5mtO/pub?output=csv";
        const APP_VERSION = "2025-07-28 23:00:00";
        const VERSION_KEY = "appVersion";

        let originalData = [];
        let currentData = [];
        let grupoColumnIndex = -1;
        let categoriaColumnIndex = -1;
        let productoColumnIndex = -1;
        let purchasedItems = new Set();
        let currentSort = { column: -1, direction: 'asc' };
        let checkInterval = null;
        let lastDataHash = null;

        const colorPalettes = {
            categoria: [
                { bg: '#e3f2fd', text: '#1565c0', border: '#2196f3' },
                { bg: '#f3e5f5', text: '#7b1fa2', border: '#9c27b0' },
                { bg: '#e8f5e8', text: '#2e7d32', border: '#4caf50' },
                { bg: '#fff3e0', text: '#ef6c00', border: '#ff9800' },
                { bg: '#fce4ec', text: '#c2185b', border: '#e91e63' },
                { bg: '#e0f2f1', text: '#00695c', border: '#009688' },
                { bg: '#f9fbe7', text: '#827717', border: '#cddc39' },
                { bg: '#e1f5fe', text: '#0277bd', border: '#03a9f4' },
                { bg: '#fff8e1', text: '#f57f17', border: '#ffeb3b' },
                { bg: '#efebe9', text: '#5d4037', border: '#795548' }
            ],
            grupo: [
                { bg: '#ffebee', text: '#c62828', border: '#f44336' },
                { bg: '#e8eaf6', text: '#303f9f', border: '#3f51b5' },
                { bg: '#e4f4fd', text: '#1976d2', border: '#2196f3' },
                { bg: '#e0f7fa', text: '#00838f', border: '#00bcd4' },
                { bg: '#f1f8e9', text: '#558b2f', border: '#8bc34a' },
                { bg: '#fff9c4', text: '#f9a825', border: '#ffc107' },
                { bg: '#fbe9e7', text: '#d84315', border: '#ff5722' },
                { bg: '#f3e5f5', text: '#8e24aa', border: '#9c27b0' },
                { bg: '#e8f5e8', text: '#388e3c', border: '#4caf50' },
                { bg: '#ede7f6', text: '#512da8', border: '#673ab7' }
            ]
        };

        let categoriaColors = new Map();
        let grupoColors = new Map();

        // Function to normalize text by removing accents/tildes
        function normalizeText(text) {
            if (!text) return '';
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, ''); // Remove diacritical marks
        }

        function getCategoriaColor(categoria) {
            if (!categoria) return null;

            if (!categoriaColors.has(categoria)) {
                const colorIndex = categoriaColors.size % colorPalettes.categoria.length;
                categoriaColors.set(categoria, colorPalettes.categoria[colorIndex]);
            }

            return categoriaColors.get(categoria);
        }

        function getGrupoColor(grupo) {
            if (!grupo) return null;

            if (!grupoColors.has(grupo)) {
                const colorIndex = grupoColors.size % colorPalettes.grupo.length;
                grupoColors.set(grupo, colorPalettes.grupo[colorIndex]);
            }

            return grupoColors.get(grupo);
        }

        function loadPurchasedState() {
            const saved = localStorage.getItem('purchasedItems');
            if (saved) {
                purchasedItems = new Set(JSON.parse(saved));
            }
        }

        function savePurchasedState() {
            localStorage.setItem('purchasedItems', JSON.stringify([...purchasedItems]));
        }

        function loadFiltersState() {
            const savedGrupo = localStorage.getItem('grupoFilter');
            const savedCategoria = localStorage.getItem('categoriaFilter');
            const savedProductoSearch = localStorage.getItem('productoSearch');
            const savedEstadoFilter = localStorage.getItem('estadoFilter');

            if (savedGrupo) {
                const grupoSelect = document.getElementById('grupoFilter');
                if (grupoSelect) {
                    grupoSelect.value = savedGrupo;
                }
            }

            if (savedCategoria) {
                const categoriaSelect = document.getElementById('categoriaFilter');
                if (categoriaSelect) {
                    categoriaSelect.value = savedCategoria;
                }
            }

            if (savedProductoSearch) {
                const productoSearchInput = document.getElementById('productoSearch');
                if (productoSearchInput) {
                    productoSearchInput.value = savedProductoSearch;
                }
            }

            if (savedEstadoFilter) {
                const estadoRadio = document.querySelector(`input[name="estadoFilter"][value="${savedEstadoFilter}"]`);
                if (estadoRadio) {
                    estadoRadio.checked = true;
                }
            }
        }

        function saveFiltersState() {
            const grupoFilter = document.getElementById('grupoFilter').value;
            const categoriaFilter = document.getElementById('categoriaFilter').value;
            const productoSearch = document.getElementById('productoSearch').value;
            const estadoFilter = document.querySelector('input[name="estadoFilter"]:checked').value;

            localStorage.setItem('grupoFilter', grupoFilter);
            localStorage.setItem('categoriaFilter', categoriaFilter);
            localStorage.setItem('productoSearch', productoSearch);
            localStorage.setItem('estadoFilter', estadoFilter);
        }

        function generateRowId(row) {
            return btoa(row.join('|')).replace(/[^a-zA-Z0-9]/g, '');
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const result = [];

            for (let line of lines) {
                if (line.trim()) {
                    const row = line.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                    result.push(row);
                }
            }

            return result;
        }

        function sortData(columnIndex, direction = 'asc') {
            if (!currentData.length || columnIndex < 0) return;

            const headers = currentData[0];
            const dataRows = currentData.slice(1);

            dataRows.sort((a, b) => {
                const valueA = (a[columnIndex] || '').toString().toLowerCase();
                const valueB = (b[columnIndex] || '').toString().toLowerCase();

                if (direction === 'asc') {
                    return valueA.localeCompare(valueB, 'es', { numeric: true });
                } else {
                    return valueB.localeCompare(valueA, 'es', { numeric: true });
                }
            });

            const sortedData = [headers, ...dataRows];
            createTable(sortedData);
        }

        function handleHeaderClick(columnIndex, columnName) {
            const sortableColumns = ['Producto', 'Grupo', 'Categor√≠a'];
            if (!sortableColumns.includes(columnName)) return;

            let direction = 'asc';
            if (currentSort.column === columnIndex && currentSort.direction === 'asc') {
                direction = 'desc';
            }

            currentSort = { column: columnIndex, direction };
            sortData(columnIndex, direction);
            updateSortIndicators();
        }

        function updateSortIndicators() {
            const headers = document.querySelectorAll('#tableHeader th');
            headers.forEach((th, index) => {
                const sortIcon = th.querySelector('.sort-icon');
                if (sortIcon) {
                    if (currentSort.column === index - 1) {
                        sortIcon.textContent = currentSort.direction === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
                        sortIcon.style.opacity = '1';
                    } else {
                        sortIcon.textContent = ' ‚ñ≤‚ñº';
                        sortIcon.style.opacity = '0.3';
                    }
                }
            });
        }

        function updateFiltersBasedOnSelection() {
            if (!originalData.length) return;

            const grupoFilter = document.getElementById('grupoFilter').value;
            const categoriaFilter = document.getElementById('categoriaFilter').value;
            const estadoFilter = document.querySelector('input[name="estadoFilter"]:checked').value;
            const headers = originalData[0];

            let dataForCounters = originalData.slice(1);

            if (grupoFilter && grupoColumnIndex !== -1) {
                dataForCounters = dataForCounters.filter(row => row[grupoColumnIndex] === grupoFilter);
            }

            if (categoriaFilter && categoriaColumnIndex !== -1) {
                dataForCounters = dataForCounters.filter(row => row[categoriaColumnIndex] === categoriaFilter);
            }

            const grupos = new Map();
            const categorias = new Map();

            dataForCounters.forEach(row => {
                const rowId = generateRowId(row);
                const isComprado = purchasedItems.has(rowId);

                if (grupoColumnIndex !== -1 && row[grupoColumnIndex]) {
                    const grupo = row[grupoColumnIndex];
                    if (!grupos.has(grupo)) {
                        grupos.set(grupo, { total: 0, comprados: 0 });
                    }
                    const stats = grupos.get(grupo);
                    stats.total += 1;
                    if (isComprado) stats.comprados += 1;
                }

                if (categoriaColumnIndex !== -1 && row[categoriaColumnIndex]) {
                    const categoria = row[categoriaColumnIndex];
                    if (!categorias.has(categoria)) {
                        categorias.set(categoria, { total: 0, comprados: 0 });
                    }
                    const stats = categorias.get(categoria);
                    stats.total += 1;
                    if (isComprado) stats.comprados += 1;
                }
            });

            const grupoSelect = document.getElementById('grupoFilter');
            const currentGrupoValue = grupoSelect.value;
            grupoSelect.innerHTML = '<option value="">Todos los grupos</option>';

            if (!categoriaFilter) {
                const allGrupos = new Map();
                for (let i = 1; i < originalData.length; i++) {
                    const row = originalData[i];
                    const rowId = generateRowId(row);
                    const isComprado = purchasedItems.has(rowId);

                    if (grupoColumnIndex !== -1 && row[grupoColumnIndex]) {
                        const grupo = row[grupoColumnIndex];
                        if (!allGrupos.has(grupo)) {
                            allGrupos.set(grupo, { total: 0, comprados: 0 });
                        }
                        const stats = allGrupos.get(grupo);
                        stats.total += 1;
                        if (isComprado) stats.comprados += 1;
                    }
                }

                allGrupos.forEach((stats, grupo) => {
                    const option = document.createElement('option');
                    option.value = grupo;
                    option.textContent = `${grupo} (${stats.comprados} de ${stats.total})`;
                    grupoSelect.appendChild(option);
                });
            } else {
                grupos.forEach((stats, grupo) => {
                    const option = document.createElement('option');
                    option.value = grupo;
                    option.textContent = `${grupo} (${stats.comprados} de ${stats.total})`;
                    grupoSelect.appendChild(option);
                });
            }

            grupoSelect.value = currentGrupoValue;

            const categoriaSelect = document.getElementById('categoriaFilter');
            const currentCategoriaValue = categoriaSelect.value;
            categoriaSelect.innerHTML = '<option value="">Todas las categor√≠as</option>';

            if (!grupoFilter) {
                const allCategorias = new Map();
                for (let i = 1; i < originalData.length; i++) {
                    const row = originalData[i];
                    const rowId = generateRowId(row);
                    const isComprado = purchasedItems.has(rowId);

                    if (categoriaColumnIndex !== -1 && row[categoriaColumnIndex]) {
                        const categoria = row[categoriaColumnIndex];
                        if (!allCategorias.has(categoria)) {
                            allCategorias.set(categoria, { total: 0, comprados: 0 });
                        }
                        const stats = allCategorias.get(categoria);
                        stats.total += 1;
                        if (isComprado) stats.comprados += 1;
                    }
                }

                allCategorias.forEach((stats, categoria) => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = `${categoria} (${stats.comprados} de ${stats.total})`;
                    categoriaSelect.appendChild(option);
                });
            } else {
                categorias.forEach((stats, categoria) => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = `${categoria} (${stats.comprados} de ${stats.total})`;
                    categoriaSelect.appendChild(option);
                });
            }

            categoriaSelect.value = currentCategoriaValue;
        }

        function populateFilters(data) {
            if (data.length === 0) return;

            const headers = data[0];

            grupoColumnIndex = headers.indexOf('Grupo');
            categoriaColumnIndex = headers.indexOf('Categor√≠a');
            productoColumnIndex = headers.indexOf('Producto');

            if (grupoColumnIndex === -1 && categoriaColumnIndex === -1) return;

            updateFiltersBasedOnSelection();
            loadFiltersState();

            const grupoSelect = document.getElementById('grupoFilter');
            const categoriaSelect = document.getElementById('categoriaFilter');
            const productoSearchInput = document.getElementById('productoSearch');
            const clearSearchButton = document.getElementById('clearSearch');

            grupoSelect.addEventListener('change', () => {
                saveFiltersState();
                updateFiltersBasedOnSelection();
                filterData();
            });

            categoriaSelect.addEventListener('change', () => {
                saveFiltersState();
                updateFiltersBasedOnSelection();
                filterData();
            });

            productoSearchInput.addEventListener('input', () => {
                saveFiltersState();
                filterData();
            });

            clearSearchButton.addEventListener('click', () => {
                productoSearchInput.value = '';
                saveFiltersState();
                filterData();
                productoSearchInput.focus();
            });

            const estadoRadios = document.querySelectorAll('input[name="estadoFilter"]');
            estadoRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    saveFiltersState();
                    updateFiltersBasedOnSelection();
                    filterData();
                });
            });
        }

        function filterData() {
            const grupoFilter = document.getElementById('grupoFilter').value;
            const categoriaFilter = document.getElementById('categoriaFilter').value;
            const productoSearch = document.getElementById('productoSearch').value.toLowerCase().trim();
            const estadoFilter = document.querySelector('input[name="estadoFilter"]:checked').value;

            if (!originalData.length) return;

            let filteredData = [originalData[0]];

            for (let i = 1; i < originalData.length; i++) {
                const row = originalData[i];
                let showRow = true;

                if (grupoFilter && grupoColumnIndex !== -1) {
                    if (row[grupoColumnIndex] !== grupoFilter) {
                        showRow = false;
                    }
                }

                if (categoriaFilter && categoriaColumnIndex !== -1) {
                    if (row[categoriaColumnIndex] !== categoriaFilter) {
                        showRow = false;
                    }
                }

                if (productoSearch && productoColumnIndex !== -1) {
                    const producto = normalizeText(row[productoColumnIndex] || '');
                    const searchTerm = normalizeText(productoSearch);
                    if (!producto.includes(searchTerm)) {
                        showRow = false;
                    }
                }

                if (estadoFilter === 'comprado') {
                    const rowId = generateRowId(row);
                    if (!purchasedItems.has(rowId)) {
                        showRow = false;
                    }
                } else if (estadoFilter === 'no-comprado') {
                    const rowId = generateRowId(row);
                    if (purchasedItems.has(rowId)) {
                        showRow = false;
                    }
                }

                if (showRow) {
                    filteredData.push(row);
                }
            }

            currentData = filteredData;

            if (currentSort.column >= 0) {
                sortData(currentSort.column, currentSort.direction);
            } else {
                createTable(filteredData);
            }

            const itemsContainer = document.getElementById('itemsContainer');
            if (itemsContainer) {
                itemsContainer.scrollTop = 0;
            }
        }

        function createTable(data) {
            const itemsContainer = document.getElementById('itemsContainer');

            itemsContainer.innerHTML = '';

            if (data.length === 0) {
                showError('No hay datos disponibles');
                return;
            }

            if (data.length === 1) {
                const noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'no-results';
                noResultsDiv.innerHTML = `
                    <div class="no-results-icon">üîç</div>
                    <div class="no-results-message">No se encontraron resultados</div>
                    <div class="no-results-suggestion">Prueba a cambiar los filtros para ver m√°s elementos</div>
                `;
                itemsContainer.appendChild(noResultsDiv);

                hideLoading();
                itemsContainer.style.display = 'block';
                return;
            }

            currentData = data;
            const headers = data[0];

            const indices = {
                producto: headers.indexOf('Producto'),
                cantidad: headers.indexOf('Cantidad'),
                unidad: headers.indexOf('Unidad'),
                categoria: headers.indexOf('Categor√≠a'),
                grupo: headers.indexOf('Grupo'),
                notas: headers.indexOf('Notas')
            };

            const dataRows = data.slice(1);
            const notPurchased = [];
            const purchased = [];

            dataRows.forEach(row => {
                const rowId = generateRowId(row);
                if (purchasedItems.has(rowId)) {
                    purchased.push(row);
                } else {
                    notPurchased.push(row);
                }
            });

            const orderedRows = [...notPurchased, ...purchased];

            orderedRows.forEach((row, index) => {
                const rowId = generateRowId(row);

                const card = document.createElement('div');
                card.className = 'item-card';
                card.setAttribute('data-row-id', rowId);

                const leftSection = document.createElement('div');
                leftSection.className = 'card-left';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'purchase-checkbox';
                checkbox.checked = purchasedItems.has(rowId);
                checkbox.addEventListener('change', () => handlePurchaseToggle(checkbox, rowId));
                leftSection.appendChild(checkbox);

                const rightSection = document.createElement('div');
                rightSection.className = 'card-right';

                const line1 = document.createElement('div');
                line1.className = 'card-line line-1';

                const producto = document.createElement('span');
                producto.className = 'producto';
                producto.textContent = row[indices.producto] || '';

                const cantidadUnidad = document.createElement('span');
                cantidadUnidad.className = 'cantidad-unidad';
                const cantidad = row[indices.cantidad] || '';
                const unidad = row[indices.unidad] || '';
                cantidadUnidad.textContent = cantidad + (unidad ? ` ${unidad}` : '');

                line1.appendChild(producto);
                line1.appendChild(cantidadUnidad);

                const line2 = document.createElement('div');
                line2.className = 'card-line line-2';

                const categoria = document.createElement('span');
                categoria.className = 'categoria';
                categoria.textContent = row[indices.categoria] || '';

                const grupo = document.createElement('span');
                grupo.className = 'grupo';
                grupo.textContent = row[indices.grupo] || '';

                line2.appendChild(categoria);
                line2.appendChild(grupo);

                const notasContent = row[indices.notas] || '';
                let line3 = null;
                if (notasContent.trim()) {
                    line3 = document.createElement('div');
                    line3.className = 'card-line line-3';

                    const notas = document.createElement('span');
                    notas.className = 'notas';
                    notas.textContent = notasContent;

                    line3.appendChild(notas);
                }

                rightSection.appendChild(line1);
                rightSection.appendChild(line2);
                if (line3) {
                    rightSection.appendChild(line3);
                }

                card.appendChild(leftSection);
                card.appendChild(rightSection);

                if (purchasedItems.has(rowId)) {
                    card.classList.add('purchased');
                }

                const categoriaColor = getCategoriaColor(row[indices.categoria]);
                const grupoColor = getGrupoColor(row[indices.grupo]);

                if (categoriaColor) {
                    const { bg, text, border } = categoriaColor;
                    categoria.style.backgroundColor = bg;
                    categoria.style.color = text;
                    categoria.style.borderColor = border;
                }

                if (grupoColor) {
                    const { bg, text, border } = grupoColor;
                    grupo.style.backgroundColor = bg;
                    grupo.style.color = text;
                    grupo.style.borderColor = border;
                }

                itemsContainer.appendChild(card);
            });

            hideLoading();
            itemsContainer.style.display = 'block';
        }

        function moveElementToPosition(element, isMovingToEnd) {
            element.classList.add('moving');

            if (isMovingToEnd) {
                element.style.transform = 'translateX(100%)';
                element.style.opacity = '0.3';
            } else {
                element.style.transform = 'translateX(-100%)';
                element.style.opacity = '0.3';
            }

            setTimeout(() => {
                createTable(currentData);
            }, 300);
        }

        function handlePurchaseToggle(checkbox, rowId) {
            const card = checkbox.closest('.item-card');

            if (checkbox.checked) {
                purchasedItems.add(rowId);
                card.classList.add('purchased');
            } else {
                purchasedItems.delete(rowId);
                card.classList.remove('purchased');
            }

            savePurchasedState();

            const estadoFilter = document.querySelector('input[name="estadoFilter"]:checked').value;

            if (estadoFilter === 'no-comprado' && checkbox.checked) {
                filterData();
            } else if (estadoFilter === 'comprado' && !checkbox.checked) {
                filterData();
            } else {
                if (checkbox.checked) {
                    moveElementToPosition(card, true);
                } else {
                    moveElementToPosition(card, false);
                }
            }

            setTimeout(() => {
                updateFiltersBasedOnSelection();
            }, 100);
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('itemsContainer').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showError(message) {
            hideLoading();
            const errorDiv = document.getElementById('error');
            errorDiv.querySelector('.error-message').textContent = message;
            errorDiv.style.display = 'block';

            const retryButton = document.getElementById('retryButton');
            if (retryButton && !retryButton.hasAttribute('data-listener-added')) {
                retryButton.addEventListener('click', () => {
                    errorDiv.style.display = 'none';
                    loadData();
                });
                retryButton.setAttribute('data-listener-added', 'true');
            }
        }

        async function loadData() {
            showLoading();

            try {
                const timestamp = new Date().getTime();
                const urlWithCache = `${CSV_URL}&_cache_bust=${timestamp}`;
                const response = await fetch(urlWithCache);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csvText = await response.text();
                const data = parseCSV(csvText);

                originalData = data;
                currentData = data;

                lastDataHash = generateDataHash(data);

                currentSort = { column: -1, direction: 'asc' };

                loadPurchasedState();
                populateFilters(data);
                loadFiltersState();

                setTimeout(() => {
                    updateFiltersBasedOnSelection();

                    const savedGrupo = localStorage.getItem('grupoFilter');
                    const savedCategoria = localStorage.getItem('categoriaFilter');
                    const savedProductoSearch = localStorage.getItem('productoSearch');

                    if (savedGrupo || savedCategoria || savedProductoSearch) {
                        filterData();
                    } else {
                        createTable(data);
                    }
                }, 100);

            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error al cargar los datos');
            }
        }

        function generateDataHash(data) {
            const jsonString = JSON.stringify(data);
            let hash = 0;
            for (let i = 0; i < jsonString.length; i++) {
                const char = jsonString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return hash.toString();
        }

        function showChangesDetectedPopup() {
            const overlay = document.createElement('div');
            overlay.id = 'changesOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                z-index: 2000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;

            const popup = document.createElement('div');
            popup.style.cssText = `
                background: linear-gradient(145deg, #ffffff, #f8f9fa);
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                padding: 30px;
                max-width: 400px;
                width: 100%;
                text-align: center;
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;

            popup.innerHTML = `
                <div style="font-size: 48px; margin-bottom: 16px;">üîÑ</div>
                <h3 style="color: #2c3e50; margin: 0 0 16px; font-size: 1.4rem;">¬°Cambios detectados!</h3>
                <p style="color: #495057; margin: 0 0 24px; line-height: 1.5;">
                    Se han detectado cambios en la lista de compras. 
                    Haz clic en "Refrescar" para cargar los nuevos datos.
                </p>
                <div style="display: flex; gap: 12px; justify-content: center;">
                    <button id="dismissChanges" style="
                        background: #6c757d;
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        transition: all 0.3s ease;
                    ">Ignorar</button>
                    <button id="refreshPage" style="
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border: none;
                        padding: 12px 20px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    ">Refrescar</button>
                </div>
            `;

            overlay.appendChild(popup);
            document.body.appendChild(overlay);

            document.getElementById('dismissChanges').addEventListener('click', () => {
                document.body.removeChild(overlay);
            });

            document.getElementById('refreshPage').addEventListener('click', () => {
                location.reload();
            });

            const buttons = popup.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('mouseenter', () => {
                    button.style.transform = 'translateY(-2px)';
                });
                button.addEventListener('mouseleave', () => {
                    button.style.transform = 'translateY(0)';
                });
            });
        }

        async function checkForDataChanges() {
            try {
                const timestamp = new Date().getTime();
                const urlWithCache = `${CSV_URL}&_cache_bust=${timestamp}`;
                const response = await fetch(urlWithCache);

                if (!response.ok) {
                    console.log('Error al verificar cambios:', response.status);
                    return;
                }

                const csvText = await response.text();
                const newData = parseCSV(csvText);
                const newDataHash = generateDataHash(newData);

                if (lastDataHash && lastDataHash !== newDataHash) {
                    console.log('Cambios detectados en los datos');
                    showChangesDetectedPopup();
                    if (checkInterval) {
                        clearInterval(checkInterval);
                        checkInterval = null;
                    }
                }

                lastDataHash = newDataHash;

            } catch (error) {
                console.log('Error al verificar cambios:', error);
            }
        }

        function startDataChangeTimer() {
            checkInterval = setInterval(checkForDataChanges, 30000);
            console.log('Temporizador de verificaci√≥n de cambios iniciado (cada 30s)');
        }

        function stopDataChangeTimer() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
                console.log('Temporizador de verificaci√≥n detenido');
            }
        }

        function checkAppVersion() {
            const savedVersion = localStorage.getItem(VERSION_KEY);

            if (savedVersion !== APP_VERSION) {
                showVersionUpdateModal();
                return false;
            }

            return true;
        }

        function updateAppVersion() {
            localStorage.setItem(VERSION_KEY, APP_VERSION);
        }

        function showVersionUpdateModal() {
            const overlay = document.createElement('div');
            overlay.id = 'versionUpdateOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                backdrop-filter: blur(8px);
                z-index: 3000;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease-out;
            `;

            const modal = document.createElement('div');
            modal.style.cssText = `
                background: linear-gradient(145deg, #ffffff, #f8f9fa);
                border-radius: 20px;
                box-shadow: 0 25px 80px rgba(0, 0, 0, 0.4);
                padding: 40px;
                max-width: 450px;
                width: 90%;
                text-align: center;
                border: 2px solid rgba(255, 255, 255, 0.3);
                position: relative;
                overflow: hidden;
            `;

            modal.innerHTML = `
                <div style="font-size: 64px; margin-bottom: 20px; animation: bounce 1s ease-out;">üîÑ</div>
                <h2 style="color: #2c3e50; margin: 0 0 16px; font-size: 1.6rem; font-weight: 700;">
                    ¬°Nueva versi√≥n disponible!
                </h2>
                <p style="color: #495057; margin: 0 0 24px; line-height: 1.6; font-size: 1.1rem;">
                    Se ha detectado una nueva versi√≥n de la aplicaci√≥n con mejoras y correcciones. 
                    <strong>Es necesario actualizar</strong> para continuar usando la aplicaci√≥n correctamente.
                </p>
                <div style="background: #fff3cd; padding: 16px; border-radius: 12px; margin: 20px 0; border-left: 4px solid #ffc107;">
                    <p style="margin: 0; color: #856404; font-size: 0.95rem;">
                        <strong>‚ö†Ô∏è Importante:</strong> Al actualizar, se reiniciar√°n todos los datos locales 
                        (productos marcados como comprados y filtros guardados). Ser√° necesario volver a configurar 
                        tus preferencias despu√©s de la actualizaci√≥n.
                    </p>
                </div>
                <button id="updateAppButton" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 16px 32px;
                    border-radius: 12px;
                    cursor: pointer;
                    font-size: 16px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
                    width: 100%;
                    text-transform: uppercase;
                    letter-spacing: 1px;
                ">
                    Actualizar Aplicaci√≥n
                </button>
            `;

            const style = document.createElement('style');
            style.textContent = `
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
                @keyframes bounce {
                    0%, 20%, 53%, 80%, 100% { transform: translate3d(0,0,0); }
                    40%, 43% { transform: translate3d(0, -20px, 0); }
                    70% { transform: translate3d(0, -10px, 0); }
                    90% { transform: translate3d(0, -4px, 0); }
                }
            `;
            document.head.appendChild(style);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            const updateButton = document.getElementById('updateAppButton');
            updateButton.addEventListener('mouseenter', () => {
                updateButton.style.transform = 'translateY(-3px)';
                updateButton.style.boxShadow = '0 8px 25px rgba(102, 126, 234, 0.6)';
            });
            updateButton.addEventListener('mouseleave', () => {
                updateButton.style.transform = 'translateY(0)';
                updateButton.style.boxShadow = '0 6px 20px rgba(102, 126, 234, 0.4)';
            });

            updateButton.addEventListener('click', () => {
                // Clear all localStorage data before updating
                try {
                    localStorage.removeItem('purchasedItems');
                    localStorage.removeItem('grupoFilter');
                    localStorage.removeItem('categoriaFilter');
                    localStorage.removeItem('productoSearch');
                    localStorage.removeItem('estadoFilter');
                    // Update version after clearing
                    updateAppVersion();
                } catch (error) {
                    console.error('Error clearing localStorage:', error);
                    // Still update version even if clearing fails
                    updateAppVersion();
                }

                updateButton.textContent = 'Actualizando...';
                updateButton.style.background = '#28a745';

                setTimeout(() => {
                    location.reload();
                }, 1000);
            });
        }

        let isRefreshing = false;
        let startY = 0;
        let currentY = 0;
        let pullDistance = 0;
        const PULL_THRESHOLD = 80;
        const MAX_PULL_DISTANCE = 120;

        // Pull-to-refresh utility functions
        function updatePullIndicator(indicator, icon, text, pullDistance) {
            const resistance = Math.min(pullDistance / MAX_PULL_DISTANCE, 1);
            const adjustedDistance = pullDistance * (1 - resistance * 0.5);

            indicator.style.transform = `translateX(-50%) translateY(${adjustedDistance - 80}px)`;

            if (pullDistance > 30) {
                indicator.classList.add('visible');
            }

            if (pullDistance >= PULL_THRESHOLD) {
                text.textContent = 'Suelta para actualizar';
                icon.style.transform = 'rotate(180deg)';
                icon.textContent = '‚Üë';
            } else {
                text.textContent = 'Desliza para actualizar';
                icon.style.transform = 'rotate(0deg)';
                icon.textContent = '‚Üì';
            }
        }

        function resetPullIndicator(indicator, icon, text) {
            indicator.style.transform = 'translateX(-50%) translateY(-80px)';
            indicator.classList.remove('visible', 'refreshing');
            text.textContent = 'Desliza para actualizar';
            icon.textContent = '‚Üì';
            icon.style.transform = 'rotate(0deg)';
            isRefreshing = false;
            pullDistance = 0;
        }

        async function handlePullRefresh(indicator, icon, text) {
            if (pullDistance >= PULL_THRESHOLD && !isRefreshing) {
                isRefreshing = true;
                indicator.classList.add('refreshing');
                text.textContent = 'Actualizando...';
                icon.textContent = '‚ü≥';
                icon.style.transform = 'rotate(0deg)';

                try {
                    await new Promise(resolve => setTimeout(resolve, 500));
                    location.reload(true);
                } catch (error) {
                    console.error('Error during pull to refresh:', error);
                    text.textContent = 'Error al actualizar';
                    icon.textContent = '‚úó';
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            resetPullIndicator(indicator, icon, text);
        }

        function setupTouchEvents(container, indicator, icon, text, state) {
            container.addEventListener('touchstart', (e) => {
                if (isRefreshing) return;

                const itemsContainer = document.getElementById('itemsContainer');
                const isAtTop = itemsContainer.scrollTop === 0;

                if (isAtTop) {
                    startY = e.touches[0].clientY;
                    state.isTouching = true;
                    state.canPull = true;
                }
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (!state.isTouching || !state.canPull || isRefreshing) return;

                currentY = e.touches[0].clientY;
                pullDistance = Math.max(0, currentY - startY);
                pullDistance = Math.min(pullDistance, MAX_PULL_DISTANCE);

                if (pullDistance > 10) {
                    updatePullIndicator(indicator, icon, text, pullDistance);
                }
            }, { passive: true });

            container.addEventListener('touchend', async (e) => {
                if (!state.isTouching || !state.canPull) return;

                state.isTouching = false;
                state.canPull = false;

                await handlePullRefresh(indicator, icon, text);
            }, { passive: true });

            container.addEventListener('touchmove', (e) => {
                if (pullDistance > 10 && !isRefreshing) {
                    e.preventDefault();
                }
            }, { passive: false });
        }

        function setupMouseEvents(container, indicator, icon, text, state) {
            container.addEventListener('mousedown', (e) => {
                if (isRefreshing) return;

                const itemsContainer = document.getElementById('itemsContainer');
                const isAtTop = itemsContainer.scrollTop === 0;

                if (isAtTop) {
                    startY = e.clientY;
                    state.isMouseDown = true;
                    state.canPull = true;
                    e.preventDefault();
                }
            });

            container.addEventListener('mousemove', (e) => {
                if (!state.isMouseDown || !state.canPull || isRefreshing) return;

                currentY = e.clientY;
                pullDistance = Math.max(0, currentY - startY);
                pullDistance = Math.min(pullDistance, MAX_PULL_DISTANCE);

                if (pullDistance > 10) {
                    updatePullIndicator(indicator, icon, text, pullDistance);
                }
                e.preventDefault();
            });

            container.addEventListener('mouseup', async (e) => {
                if (!state.isMouseDown || !state.canPull) return;

                state.isMouseDown = false;
                state.canPull = false;

                await handlePullRefresh(indicator, icon, text);
            });
        }

        function initPullToRefresh() {
            const containers = [
                document.querySelector('.welcome-message'),
                document.querySelector('.items-container')
            ];
            const indicator = document.getElementById('pullToRefreshIndicator');
            const icon = indicator.querySelector('.pull-refresh-icon');
            const text = indicator.querySelector('.pull-refresh-text');

            // Shared state object
            const globalState = {
                isTouching: false,
                canPull: false,
                isMouseDown: false
            };

            containers.forEach(container => {
                if (!container) return;

                setupTouchEvents(container, indicator, icon, text, globalState);
                setupMouseEvents(container, indicator, icon, text, globalState);
            });

            // Global mouse events for desktop (when mouse leaves container)
            document.addEventListener('mousemove', (e) => {
                if (!globalState.isMouseDown || !globalState.canPull || isRefreshing) return;

                currentY = e.clientY;
                pullDistance = Math.max(0, currentY - startY);
                pullDistance = Math.min(pullDistance, MAX_PULL_DISTANCE);

                if (pullDistance > 10) {
                    updatePullIndicator(indicator, icon, text, pullDistance);
                }
            });

            document.addEventListener('mouseup', async (e) => {
                if (!globalState.isMouseDown || !globalState.canPull) return;

                globalState.isMouseDown = false;
                globalState.canPull = false;

                await handlePullRefresh(indicator, icon, text);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            const versionOK = checkAppVersion();

            if (versionOK) {
                loadData();
                startDataChangeTimer();
                initPullToRefresh();
                updateAppVersion();
            }

            const helpButton = document.getElementById('helpButton');
            const helpModal = document.getElementById('helpModal');
            const closeHelp = document.getElementById('closeHelp');

            helpButton.addEventListener('click', () => {
                helpModal.style.display = 'block';
            });

            closeHelp.addEventListener('click', () => {
                helpModal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target === helpModal) {
                    helpModal.style.display = 'none';
                }
            });

            const resetAppButton = document.getElementById('resetAppButton');
            if (resetAppButton) {
                resetAppButton.addEventListener('click', () => {
                    const confirmation = confirm(
                        '‚ö†Ô∏è ¬øEst√°s seguro de que quieres resetear la aplicaci√≥n?\n\n' +
                        'Esta acci√≥n eliminar√° PERMANENTEMENTE:\n' +
                        '‚Ä¢ Todos los productos marcados como comprados\n' +
                        '‚Ä¢ Filtros guardados (grupo, categor√≠a, b√∫squeda)\n' +
                        '‚Ä¢ Estado de b√∫squeda actual\n\n' +
                        'No se puede deshacer esta acci√≥n.'
                    );

                    if (confirmation) {
                        const doubleConfirmation = confirm(
                            'üö® √öLTIMA CONFIRMACI√ìN üö®\n\n' +
                            'Vas a eliminar TODOS los datos guardados de la aplicaci√≥n.\n\n' +
                            '¬øProceder con el reseteo completo?'
                        );

                        if (doubleConfirmation) {
                            try {
                                localStorage.removeItem('purchasedItems');
                                localStorage.removeItem('grupoFilter');
                                localStorage.removeItem('categoriaFilter');
                                localStorage.removeItem('productoSearch');
                                localStorage.removeItem('estadoFilter');

                                alert('‚úÖ Aplicaci√≥n reseteada correctamente.\n\nLa p√°gina se recargar√° para aplicar los cambios.');
                                location.reload();
                            } catch (error) {
                                console.error('Error al resetear la aplicaci√≥n:', error);
                                alert('‚ùå Error al resetear la aplicaci√≥n. Por favor, int√©ntalo de nuevo.');
                            }
                        }
                    }
                });
            }
        });
    </script>
</body>

</html>
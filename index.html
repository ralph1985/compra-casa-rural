<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Compras - Casa Rural</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="welcome-message">
            <h1>Gestión de la compra - Casa Rural</h1>
        </div>

        <div class="table-container">
            <div class="filters-container">
                <div class="filter-group">
                    <label for="grupoFilter">Filtrar por Grupo:</label>
                    <select id="grupoFilter">
                        <option value="">Todos los grupos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="categoriaFilter">Filtrar por Categoría:</label>
                    <select id="categoriaFilter">
                        <option value="">Todas las categorías</option>
                    </select>
                </div>
            </div>

            <div id="loading" class="loading">Cargando...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div id="itemsContainer" class="items-container" style="display: none;"></div>
        </div>
    </div>

    <script>
        // URL del CSV de Google Sheets
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzU3A2YW5jGO4jF0lGpfEnJGCuUEOs1dKCl7zPVZma60j1sityN2DNhXW9RwJpEecyq-wUXow_5mtO/pub?output=csv";

        // Variables globales para almacenar datos
        let originalData = [];
        let currentData = [];
        let grupoColumnIndex = -1;
        let categoriaColumnIndex = -1;
        let productoColumnIndex = -1;
        let purchasedItems = new Set();
        let currentSort = { column: -1, direction: 'asc' };

        // Paletas de colores para categorías y grupos
        const colorPalettes = {
            categoria: [
                { bg: '#e3f2fd', text: '#1565c0', border: '#2196f3' }, // Azul
                { bg: '#f3e5f5', text: '#7b1fa2', border: '#9c27b0' }, // Púrpura
                { bg: '#e8f5e8', text: '#2e7d32', border: '#4caf50' }, // Verde
                { bg: '#fff3e0', text: '#ef6c00', border: '#ff9800' }, // Naranja
                { bg: '#fce4ec', text: '#c2185b', border: '#e91e63' }, // Rosa
                { bg: '#e0f2f1', text: '#00695c', border: '#009688' }, // Teal
                { bg: '#f9fbe7', text: '#827717', border: '#cddc39' }, // Lima
                { bg: '#e1f5fe', text: '#0277bd', border: '#03a9f4' }, // Azul claro
                { bg: '#fff8e1', text: '#f57f17', border: '#ffeb3b' }, // Amarillo
                { bg: '#efebe9', text: '#5d4037', border: '#795548' }  // Marrón
            ],
            grupo: [
                { bg: '#ffebee', text: '#c62828', border: '#f44336' }, // Rojo
                { bg: '#e8eaf6', text: '#303f9f', border: '#3f51b5' }, // Índigo
                { bg: '#e4f4fd', text: '#1976d2', border: '#2196f3' }, // Azul material
                { bg: '#e0f7fa', text: '#00838f', border: '#00bcd4' }, // Cian
                { bg: '#f1f8e9', text: '#558b2f', border: '#8bc34a' }, // Verde claro
                { bg: '#fff9c4', text: '#f9a825', border: '#ffc107' }, // Ámbar
                { bg: '#fbe9e7', text: '#d84315', border: '#ff5722' }, // Naranja profundo
                { bg: '#f3e5f5', text: '#8e24aa', border: '#9c27b0' }, // Púrpura material
                { bg: '#e8f5e8', text: '#388e3c', border: '#4caf50' }, // Verde material
                { bg: '#ede7f6', text: '#512da8', border: '#673ab7' }  // Violeta profundo
            ]
        };

        // Mapas para almacenar colores asignados
        let categoriaColors = new Map();
        let grupoColors = new Map();

        // Función para asignar color a una categoría
        function getCategoriaColor(categoria) {
            if (!categoria) return null;

            if (!categoriaColors.has(categoria)) {
                const colorIndex = categoriaColors.size % colorPalettes.categoria.length;
                categoriaColors.set(categoria, colorPalettes.categoria[colorIndex]);
            }

            return categoriaColors.get(categoria);
        }

        // Función para asignar color a un grupo
        function getGrupoColor(grupo) {
            if (!grupo) return null;

            if (!grupoColors.has(grupo)) {
                const colorIndex = grupoColors.size % colorPalettes.grupo.length;
                grupoColors.set(grupo, colorPalettes.grupo[colorIndex]);
            }

            return grupoColors.get(grupo);
        }

        // Cargar estado de localStorage
        function loadPurchasedState() {
            const saved = localStorage.getItem('purchasedItems');
            if (saved) {
                purchasedItems = new Set(JSON.parse(saved));
            }
        }

        // Guardar estado en localStorage
        function savePurchasedState() {
            localStorage.setItem('purchasedItems', JSON.stringify([...purchasedItems]));
        }

        // Cargar filtros guardados de localStorage
        function loadFiltersState() {
            const savedGrupo = localStorage.getItem('grupoFilter');
            const savedCategoria = localStorage.getItem('categoriaFilter');

            if (savedGrupo) {
                const grupoSelect = document.getElementById('grupoFilter');
                if (grupoSelect) {
                    grupoSelect.value = savedGrupo;
                }
            }

            if (savedCategoria) {
                const categoriaSelect = document.getElementById('categoriaFilter');
                if (categoriaSelect) {
                    categoriaSelect.value = savedCategoria;
                }
            }
        }

        // Guardar filtros en localStorage
        function saveFiltersState() {
            const grupoFilter = document.getElementById('grupoFilter').value;
            const categoriaFilter = document.getElementById('categoriaFilter').value;

            localStorage.setItem('grupoFilter', grupoFilter);
            localStorage.setItem('categoriaFilter', categoriaFilter);
        }

        // Generar ID único para cada fila basado en su contenido
        function generateRowId(row) {
            return btoa(row.join('|')).replace(/[^a-zA-Z0-9]/g, '');
        }

        // Manejar cambio de estado de compra
        function handlePurchaseToggle(checkbox, rowId) {
            const card = checkbox.closest('.item-card');

            if (checkbox.checked) {
                purchasedItems.add(rowId);
                card.classList.add('purchased');
            } else {
                purchasedItems.delete(rowId);
                card.classList.remove('purchased');
            }

            savePurchasedState();

            // Actualizar los filtros para reflejar los nuevos conteos
            populateFilters(originalData);
        }

        // Función para parsear CSV
        function parseCSV(text) {
            const lines = text.split('\n');
            const result = [];

            for (let line of lines) {
                if (line.trim()) {
                    // Simple CSV parsing - handles basic cases
                    const row = line.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                    result.push(row);
                }
            }

            return result;
        }

        // Función para ordenar datos
        function sortData(columnIndex, direction = 'asc') {
            if (!currentData.length || columnIndex < 0) return;

            const headers = currentData[0];
            const dataRows = currentData.slice(1);

            dataRows.sort((a, b) => {
                const valueA = (a[columnIndex] || '').toString().toLowerCase();
                const valueB = (b[columnIndex] || '').toString().toLowerCase();

                if (direction === 'asc') {
                    return valueA.localeCompare(valueB, 'es', { numeric: true });
                } else {
                    return valueB.localeCompare(valueA, 'es', { numeric: true });
                }
            });

            const sortedData = [headers, ...dataRows];
            createTable(sortedData);
        }

        // Función para manejar click en encabezado
        function handleHeaderClick(columnIndex, columnName) {
            const sortableColumns = ['Producto', 'Grupo', 'Categoría'];
            if (!sortableColumns.includes(columnName)) return;

            let direction = 'asc';
            if (currentSort.column === columnIndex && currentSort.direction === 'asc') {
                direction = 'desc';
            }

            currentSort = { column: columnIndex, direction };
            sortData(columnIndex, direction);
            updateSortIndicators();
        }

        // Función para actualizar indicadores de ordenación
        function updateSortIndicators() {
            const headers = document.querySelectorAll('#tableHeader th');
            headers.forEach((th, index) => {
                const sortIcon = th.querySelector('.sort-icon');
                if (sortIcon) {
                    if (currentSort.column === index - 1) { // -1 porque el checkbox ocupa el primer índice
                        sortIcon.textContent = currentSort.direction === 'asc' ? ' ▲' : ' ▼';
                        sortIcon.style.opacity = '1';
                    } else {
                        sortIcon.textContent = ' ▲▼';
                        sortIcon.style.opacity = '0.3';
                    }
                }
            });
        }

        // Función para actualizar filtros dinámicamente según la selección actual
        function updateFiltersBasedOnSelection() {
            if (!originalData.length) return;

            const grupoFilter = document.getElementById('grupoFilter').value;
            const categoriaFilter = document.getElementById('categoriaFilter').value;
            const headers = originalData[0];

            // Obtener datos filtrados para calcular opciones disponibles
            let availableData = originalData.slice(1); // Sin headers

            // Si hay filtro de grupo, filtrar primero por grupo
            if (grupoFilter && grupoColumnIndex !== -1) {
                availableData = availableData.filter(row => row[grupoColumnIndex] === grupoFilter);
            }

            // Si hay filtro de categoría, filtrar por categoría
            if (categoriaFilter && categoriaColumnIndex !== -1) {
                availableData = availableData.filter(row => row[categoriaColumnIndex] === categoriaFilter);
            }

            // Calcular estadísticas para grupos disponibles
            const grupos = new Map();
            const categorias = new Map();

            availableData.forEach(row => {
                const rowId = generateRowId(row);
                const isComprado = purchasedItems.has(rowId);

                if (grupoColumnIndex !== -1 && row[grupoColumnIndex]) {
                    const grupo = row[grupoColumnIndex];
                    if (!grupos.has(grupo)) {
                        grupos.set(grupo, { total: 0, comprados: 0 });
                    }
                    const stats = grupos.get(grupo);
                    stats.total += 1;
                    if (isComprado) stats.comprados += 1;
                }

                if (categoriaColumnIndex !== -1 && row[categoriaColumnIndex]) {
                    const categoria = row[categoriaColumnIndex];
                    if (!categorias.has(categoria)) {
                        categorias.set(categoria, { total: 0, comprados: 0 });
                    }
                    const stats = categorias.get(categoria);
                    stats.total += 1;
                    if (isComprado) stats.comprados += 1;
                }
            });

            // Actualizar selector de grupos
            const grupoSelect = document.getElementById('grupoFilter');
            const currentGrupoValue = grupoSelect.value;
            grupoSelect.innerHTML = '<option value="">Todos los grupos</option>';
            
            // Si no hay filtro de categoría, mostrar todos los grupos originales
            if (!categoriaFilter) {
                // Recalcular con todos los datos originales para grupos
                const allGrupos = new Map();
                for (let i = 1; i < originalData.length; i++) {
                    const row = originalData[i];
                    const rowId = generateRowId(row);
                    const isComprado = purchasedItems.has(rowId);
                    
                    if (grupoColumnIndex !== -1 && row[grupoColumnIndex]) {
                        const grupo = row[grupoColumnIndex];
                        if (!allGrupos.has(grupo)) {
                            allGrupos.set(grupo, { total: 0, comprados: 0 });
                        }
                        const stats = allGrupos.get(grupo);
                        stats.total += 1;
                        if (isComprado) stats.comprados += 1;
                    }
                }
                
                allGrupos.forEach((stats, grupo) => {
                    const option = document.createElement('option');
                    option.value = grupo;
                    option.textContent = `${grupo} (${stats.comprados} de ${stats.total})`;
                    grupoSelect.appendChild(option);
                });
            } else {
                // Mostrar solo grupos que tienen la categoría seleccionada
                grupos.forEach((stats, grupo) => {
                    const option = document.createElement('option');
                    option.value = grupo;
                    option.textContent = `${grupo} (${stats.comprados} de ${stats.total})`;
                    grupoSelect.appendChild(option);
                });
            }
            
            grupoSelect.value = currentGrupoValue;

            // Actualizar selector de categorías
            const categoriaSelect = document.getElementById('categoriaFilter');
            const currentCategoriaValue = categoriaSelect.value;
            categoriaSelect.innerHTML = '<option value="">Todas las categorías</option>';
            
            // Si no hay filtro de grupo, mostrar todas las categorías originales
            if (!grupoFilter) {
                // Recalcular con todos los datos originales para categorías
                const allCategorias = new Map();
                for (let i = 1; i < originalData.length; i++) {
                    const row = originalData[i];
                    const rowId = generateRowId(row);
                    const isComprado = purchasedItems.has(rowId);
                    
                    if (categoriaColumnIndex !== -1 && row[categoriaColumnIndex]) {
                        const categoria = row[categoriaColumnIndex];
                        if (!allCategorias.has(categoria)) {
                            allCategorias.set(categoria, { total: 0, comprados: 0 });
                        }
                        const stats = allCategorias.get(categoria);
                        stats.total += 1;
                        if (isComprado) stats.comprados += 1;
                    }
                }
                
                allCategorias.forEach((stats, categoria) => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = `${categoria} (${stats.comprados} de ${stats.total})`;
                    categoriaSelect.appendChild(option);
                });
            } else {
                // Mostrar solo categorías que tienen el grupo seleccionado
                categorias.forEach((stats, categoria) => {
                    const option = document.createElement('option');
                    option.value = categoria;
                    option.textContent = `${categoria} (${stats.comprados} de ${stats.total})`;
                    categoriaSelect.appendChild(option);
                });
            }
            
            categoriaSelect.value = currentCategoriaValue;
        }

        // Función para poblar los filtros
        function populateFilters(data) {
            if (data.length === 0) return;

            const headers = data[0];

            // Encontrar índices de las columnas
            grupoColumnIndex = headers.indexOf('Grupo');
            categoriaColumnIndex = headers.indexOf('Categoría');
            productoColumnIndex = headers.indexOf('Producto');

            if (grupoColumnIndex === -1 && categoriaColumnIndex === -1) return;

            // Actualizar filtros dinámicamente
            updateFiltersBasedOnSelection();

            // Cargar filtros guardados
            loadFiltersState();

            // Agregar event listeners que también guarden el estado y actualicen filtros
            const grupoSelect = document.getElementById('grupoFilter');
            const categoriaSelect = document.getElementById('categoriaFilter');

            grupoSelect.addEventListener('change', () => {
                saveFiltersState();
                updateFiltersBasedOnSelection();
                filterData();
            });
            
            categoriaSelect.addEventListener('change', () => {
                saveFiltersState();
                updateFiltersBasedOnSelection();
                filterData();
            });
        }

        // Función para filtrar datos
        function filterData() {
            const grupoFilter = document.getElementById('grupoFilter').value;
            const categoriaFilter = document.getElementById('categoriaFilter').value;

            if (!originalData.length) return;

            let filteredData = [originalData[0]]; // Mantener headers

            for (let i = 1; i < originalData.length; i++) {
                const row = originalData[i];
                let showRow = true;

                // Filtrar por grupo
                if (grupoFilter && grupoColumnIndex !== -1) {
                    if (row[grupoColumnIndex] !== grupoFilter) {
                        showRow = false;
                    }
                }

                // Filtrar por categoría
                if (categoriaFilter && categoriaColumnIndex !== -1) {
                    if (row[categoriaColumnIndex] !== categoriaFilter) {
                        showRow = false;
                    }
                }

                if (showRow) {
                    filteredData.push(row);
                }
            }

            currentData = filteredData;

            // Aplicar ordenación actual si existe
            if (currentSort.column >= 0) {
                sortData(currentSort.column, currentSort.direction);
            } else {
                createTable(filteredData);
            }

            // Resetear scroll al inicio después de filtrar
            const itemsContainer = document.getElementById('itemsContainer');
            if (itemsContainer) {
                itemsContainer.scrollTop = 0;
            }
        }

        // Función para crear la vista de tarjetas
        function createTable(data) {
            const itemsContainer = document.getElementById('itemsContainer');

            // Limpiar contenido anterior
            itemsContainer.innerHTML = '';

            if (data.length === 0) {
                showError('No hay datos disponibles');
                return;
            }

            // Verificar si hay datos después de los headers
            if (data.length === 1) {
                // Solo hay headers, no hay datos que mostrar
                const noResultsDiv = document.createElement('div');
                noResultsDiv.className = 'no-results';
                noResultsDiv.innerHTML = `
                    <div class="no-results-icon">🔍</div>
                    <div class="no-results-message">No se encontraron resultados</div>
                    <div class="no-results-suggestion">Prueba a cambiar los filtros para ver más elementos</div>
                `;
                itemsContainer.appendChild(noResultsDiv);

                hideLoading();
                itemsContainer.style.display = 'block';
                return;
            }

            // Guardar datos actuales
            currentData = data;
            const headers = data[0];

            // Encontrar índices de columnas
            const indices = {
                producto: headers.indexOf('Producto'),
                cantidad: headers.indexOf('Cantidad'),
                unidad: headers.indexOf('Unidad'),
                categoria: headers.indexOf('Categoría'),
                grupo: headers.indexOf('Grupo'),
                notas: headers.indexOf('Notas')
            };

            // Crear tarjetas de datos
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const rowId = generateRowId(row);

                // Crear contenedor de tarjeta
                const card = document.createElement('div');
                card.className = 'item-card';
                card.setAttribute('data-row-id', rowId);

                // Contenedor izquierdo para checkbox
                const leftSection = document.createElement('div');
                leftSection.className = 'card-left';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'purchase-checkbox';
                checkbox.checked = purchasedItems.has(rowId);
                checkbox.addEventListener('change', () => handlePurchaseToggle(checkbox, rowId));
                leftSection.appendChild(checkbox);

                // Contenedor derecho para información
                const rightSection = document.createElement('div');
                rightSection.className = 'card-right';

                // Primera línea: Producto, Cantidad, Unidad
                const line1 = document.createElement('div');
                line1.className = 'card-line line-1';

                const producto = document.createElement('span');
                producto.className = 'producto';
                producto.textContent = row[indices.producto] || '';

                const cantidadUnidad = document.createElement('span');
                cantidadUnidad.className = 'cantidad-unidad';
                const cantidad = row[indices.cantidad] || '';
                const unidad = row[indices.unidad] || '';
                cantidadUnidad.textContent = cantidad + (unidad ? ` ${unidad}` : '');

                line1.appendChild(producto);
                line1.appendChild(cantidadUnidad);

                // Segunda línea: Categoría y Grupo
                const line2 = document.createElement('div');
                line2.className = 'card-line line-2';

                const categoria = document.createElement('span');
                categoria.className = 'categoria';
                categoria.textContent = row[indices.categoria] || '';

                const grupo = document.createElement('span');
                grupo.className = 'grupo';
                grupo.textContent = row[indices.grupo] || '';

                line2.appendChild(categoria);
                line2.appendChild(grupo);

                // Tercera línea: Notas (solo si hay contenido)
                const notasContent = row[indices.notas] || '';
                let line3 = null;
                if (notasContent.trim()) {
                    line3 = document.createElement('div');
                    line3.className = 'card-line line-3';

                    const notas = document.createElement('span');
                    notas.className = 'notas';
                    notas.textContent = notasContent;

                    line3.appendChild(notas);
                }

                // Agregar líneas al contenedor derecho
                rightSection.appendChild(line1);
                rightSection.appendChild(line2);
                if (line3) {
                    rightSection.appendChild(line3);
                }

                // Agregar secciones a la tarjeta
                card.appendChild(leftSection);
                card.appendChild(rightSection);

                // Aplicar clase de comprado si está marcado
                if (purchasedItems.has(rowId)) {
                    card.classList.add('purchased');
                }

                // Asignar colores a categorías y grupos
                const categoriaColor = getCategoriaColor(row[indices.categoria]);
                const grupoColor = getGrupoColor(row[indices.grupo]);

                if (categoriaColor) {
                    const { bg, text, border } = categoriaColor;
                    categoria.style.backgroundColor = bg;
                    categoria.style.color = text;
                    categoria.style.borderColor = border;
                }

                if (grupoColor) {
                    const { bg, text, border } = grupoColor;
                    grupo.style.backgroundColor = bg;
                    grupo.style.color = text;
                    grupo.style.borderColor = border;
                }

                itemsContainer.appendChild(card);
            }

            // Mostrar contenedor de tarjetas
            hideLoading();
            itemsContainer.style.display = 'block';
        }

        // Función para mostrar loading
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('itemsContainer').style.display = 'none';
        }

        // Función para ocultar loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Función para mostrar error
        function showError(message) {
            hideLoading();
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Función para cargar datos
        async function loadData() {
            showLoading();

            try {
                const response = await fetch(CSV_URL);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csvText = await response.text();
                const data = parseCSV(csvText);

                // Guardar datos originales
                originalData = data;
                currentData = data;

                // Resetear ordenación
                currentSort = { column: -1, direction: 'asc' };

                // Cargar estado de compras
                loadPurchasedState();

                // Poblar filtros
                populateFilters(data);

                // Aplicar filtros guardados si existen
                const savedGrupo = localStorage.getItem('grupoFilter');
                const savedCategoria = localStorage.getItem('categoriaFilter');

                if (savedGrupo || savedCategoria) {
                    filterData();
                } else {
                    createTable(data);
                }

            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error al cargar los datos');
            }
        }

        // Cargar datos cuando la página esté lista
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>

</html>
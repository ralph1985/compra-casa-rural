<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Compras - Casa Rural</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="container">
        <div class="welcome-message">
            <h1>Gestión de la compra - Casa Rural</h1>
        </div>

        <div class="table-container">
            <h2>Lista de compras</h2>

            <div class="filters-container">
                <div class="filter-group">
                    <label for="grupoFilter">Filtrar por Grupo:</label>
                    <select id="grupoFilter">
                        <option value="">Todos los grupos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="categoriaFilter">Filtrar por Categoría:</label>
                    <select id="categoriaFilter">
                        <option value="">Todas las categorías</option>
                    </select>
                </div>
            </div>

            <div id="loading" class="loading">Cargando...</div>
            <div id="error" class="error" style="display: none;"></div>
            <div class="table-wrapper">
                <table id="dataTable" style="display: none;">
                    <thead>
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // URL del CSV de Google Sheets
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTzU3A2YW5jGO4jF0lGpfEnJGCuUEOs1dKCl7zPVZma60j1sityN2DNhXW9RwJpEecyq-wUXow_5mtO/pub?output=csv";

        // Variables globales para almacenar datos
        let originalData = [];
        let currentData = [];
        let grupoColumnIndex = -1;
        let categoriaColumnIndex = -1;
        let productoColumnIndex = -1;
        let purchasedItems = new Set();
        let currentSort = { column: -1, direction: 'asc' };

        // Cargar estado de localStorage
        function loadPurchasedState() {
            const saved = localStorage.getItem('purchasedItems');
            if (saved) {
                purchasedItems = new Set(JSON.parse(saved));
            }
        }

        // Guardar estado en localStorage
        function savePurchasedState() {
            localStorage.setItem('purchasedItems', JSON.stringify([...purchasedItems]));
        }

        // Generar ID único para cada fila basado en su contenido
        function generateRowId(row) {
            return btoa(row.join('|')).replace(/[^a-zA-Z0-9]/g, '');
        }

        // Manejar cambio de estado de compra
        function handlePurchaseToggle(checkbox, rowId) {
            const row = checkbox.closest('tr');
            
            if (checkbox.checked) {
                purchasedItems.add(rowId);
                row.classList.add('purchased');
            } else {
                purchasedItems.delete(rowId);
                row.classList.remove('purchased');
            }
            
            savePurchasedState();
        }

        // Función para parsear CSV
        function parseCSV(text) {
            const lines = text.split('\n');
            const result = [];

            for (let line of lines) {
                if (line.trim()) {
                    // Simple CSV parsing - handles basic cases
                    const row = line.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''));
                    result.push(row);
                }
            }

            return result;
        }

        // Función para ordenar datos
        function sortData(columnIndex, direction = 'asc') {
            if (!currentData.length || columnIndex < 0) return;

            const headers = currentData[0];
            const dataRows = currentData.slice(1);

            dataRows.sort((a, b) => {
                const valueA = (a[columnIndex] || '').toString().toLowerCase();
                const valueB = (b[columnIndex] || '').toString().toLowerCase();

                if (direction === 'asc') {
                    return valueA.localeCompare(valueB, 'es', { numeric: true });
                } else {
                    return valueB.localeCompare(valueA, 'es', { numeric: true });
                }
            });

            const sortedData = [headers, ...dataRows];
            createTable(sortedData);
        }

        // Función para manejar click en encabezado
        function handleHeaderClick(columnIndex, columnName) {
            const sortableColumns = ['Producto', 'Grupo', 'Categoría'];
            if (!sortableColumns.includes(columnName)) return;

            let direction = 'asc';
            if (currentSort.column === columnIndex && currentSort.direction === 'asc') {
                direction = 'desc';
            }

            currentSort = { column: columnIndex, direction };
            sortData(columnIndex, direction);
            updateSortIndicators();
        }

        // Función para actualizar indicadores de ordenación
        function updateSortIndicators() {
            const headers = document.querySelectorAll('#tableHeader th');
            headers.forEach((th, index) => {
                const sortIcon = th.querySelector('.sort-icon');
                if (sortIcon) {
                    if (currentSort.column === index - 1) { // -1 porque el checkbox ocupa el primer índice
                        sortIcon.textContent = currentSort.direction === 'asc' ? ' ▲' : ' ▼';
                        sortIcon.style.opacity = '1';
                    } else {
                        sortIcon.textContent = ' ▲▼';
                        sortIcon.style.opacity = '0.3';
                    }
                }
            });
        }

        // Función para poblar los filtros
        function populateFilters(data) {
            if (data.length === 0) return;

            const headers = data[0];
            
            // Encontrar índices de las columnas
            grupoColumnIndex = headers.indexOf('Grupo');
            categoriaColumnIndex = headers.indexOf('Categoría');
            productoColumnIndex = headers.indexOf('Producto');

            if (grupoColumnIndex === -1 && categoriaColumnIndex === -1) return;

            // Obtener valores únicos para cada filtro
            const grupos = new Set();
            const categorias = new Set();

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (grupoColumnIndex !== -1 && row[grupoColumnIndex]) {
                    grupos.add(row[grupoColumnIndex]);
                }
                if (categoriaColumnIndex !== -1 && row[categoriaColumnIndex]) {
                    categorias.add(row[categoriaColumnIndex]);
                }
            }

            // Poblar selector de grupos
            const grupoSelect = document.getElementById('grupoFilter');
            grupoSelect.innerHTML = '<option value="">Todos los grupos</option>';
            grupos.forEach(grupo => {
                const option = document.createElement('option');
                option.value = grupo;
                option.textContent = grupo;
                grupoSelect.appendChild(option);
            });

            // Poblar selector de categorías
            const categoriaSelect = document.getElementById('categoriaFilter');
            categoriaSelect.innerHTML = '<option value="">Todas las categorías</option>';
            categorias.forEach(categoria => {
                const option = document.createElement('option');
                option.value = categoria;
                option.textContent = categoria;
                categoriaSelect.appendChild(option);
            });

            // Agregar event listeners
            grupoSelect.addEventListener('change', filterData);
            categoriaSelect.addEventListener('change', filterData);
        }

        // Función para filtrar datos
        function filterData() {
            const grupoFilter = document.getElementById('grupoFilter').value;
            const categoriaFilter = document.getElementById('categoriaFilter').value;

            if (!originalData.length) return;

            let filteredData = [originalData[0]]; // Mantener headers

            for (let i = 1; i < originalData.length; i++) {
                const row = originalData[i];
                let showRow = true;

                // Filtrar por grupo
                if (grupoFilter && grupoColumnIndex !== -1) {
                    if (row[grupoColumnIndex] !== grupoFilter) {
                        showRow = false;
                    }
                }

                // Filtrar por categoría
                if (categoriaFilter && categoriaColumnIndex !== -1) {
                    if (row[categoriaColumnIndex] !== categoriaFilter) {
                        showRow = false;
                    }
                }

                if (showRow) {
                    filteredData.push(row);
                }
            }

            currentData = filteredData;
            
            // Aplicar ordenación actual si existe
            if (currentSort.column >= 0) {
                sortData(currentSort.column, currentSort.direction);
            } else {
                createTable(filteredData);
            }
        }

        // Función para crear la tabla
        function createTable(data) {
            const table = document.getElementById('dataTable');
            const header = document.getElementById('tableHeader');
            const body = document.getElementById('tableBody');

            // Limpiar contenido anterior
            header.innerHTML = '';
            body.innerHTML = '';

            if (data.length === 0) {
                showError('No hay datos disponibles');
                return;
            }

            // Guardar datos actuales
            currentData = data;

            // Crear encabezados (primera fila + columna de comprado)
            const headerRow = data[0];
            
            // Agregar columna de "Comprado" al inicio
            const purchasedTh = document.createElement('th');
            purchasedTh.textContent = 'Comprado';
            purchasedTh.style.width = '80px';
            header.appendChild(purchasedTh);
            
            headerRow.forEach((cellData, index) => {
                const th = document.createElement('th');
                const sortableColumns = ['Producto', 'Grupo', 'Categoría'];
                
                if (sortableColumns.includes(cellData)) {
                    th.style.cursor = 'pointer';
                    th.style.userSelect = 'none';
                    th.addEventListener('click', () => handleHeaderClick(index, cellData));
                    
                    const textSpan = document.createElement('span');
                    textSpan.textContent = cellData;
                    
                    const sortIcon = document.createElement('span');
                    sortIcon.className = 'sort-icon';
                    sortIcon.textContent = ' ▲▼';
                    sortIcon.style.opacity = '0.3';
                    sortIcon.style.fontSize = '0.8em';
                    
                    th.appendChild(textSpan);
                    th.appendChild(sortIcon);
                } else {
                    th.textContent = cellData;
                }
                
                header.appendChild(th);
            });

            // Crear filas de datos (resto de filas)
            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                const tr = document.createElement('tr');
                const rowId = generateRowId(row);
                
                // Agregar checkbox de comprado
                const purchasedTd = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = purchasedItems.has(rowId);
                checkbox.addEventListener('change', () => handlePurchaseToggle(checkbox, rowId));
                purchasedTd.appendChild(checkbox);
                tr.appendChild(purchasedTd);
                
                // Agregar resto de celdas
                row.forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData || '';
                    tr.appendChild(td);
                });
                
                // Aplicar clase de comprado si está marcado
                if (purchasedItems.has(rowId)) {
                    tr.classList.add('purchased');
                }
                
                body.appendChild(tr);
            }

            // Actualizar indicadores de ordenación
            updateSortIndicators();

            // Mostrar tabla
            hideLoading();
            table.style.display = 'table';
        }

        // Función para mostrar loading
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('dataTable').style.display = 'none';
        }

        // Función para ocultar loading
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // Función para mostrar error
        function showError(message) {
            hideLoading();
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // Función para cargar datos
        async function loadData() {
            showLoading();

            try {
                const response = await fetch(CSV_URL);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const csvText = await response.text();
                const data = parseCSV(csvText);
                
                // Guardar datos originales
                originalData = data;
                currentData = data;
                
                // Resetear ordenación
                currentSort = { column: -1, direction: 'asc' };
                
                // Cargar estado de compras
                loadPurchasedState();
                
                // Poblar filtros
                populateFilters(data);
                
                // Crear tabla
                createTable(data);

            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error al cargar los datos');
            }
        }

        // Cargar datos cuando la página esté lista
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>

</html>